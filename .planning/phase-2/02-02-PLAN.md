---
phase: 2
plan: 02
type: execute
domain: database
---

<objective>
ImplÃ©menter schema_translate_map dans get_user_db()

Purpose: Remplacer SET LOCAL search_path par schema_translate_map pour une isolation multi-tenant robuste
Output: get_user_db() utilise schema_translate_map, survit COMMIT/ROLLBACK
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@backend/api/dependencies/__init__.py
@backend/shared/database.py

**Phase 1 complete:** All 19 tenant models have `schema="tenant"` placeholder.
**Plan 02-01 provides:** UserBase alias, get_tenant_schema() helper.

**Current get_user_db() implementation:**
```python
# Current (fragile - lost after COMMIT/ROLLBACK)
db.execute(text(f"SET LOCAL search_path TO {schema_name}, public"))
```

**Target implementation:**
```python
# New (robust - survives COMMIT/ROLLBACK)
db = db.execution_options(schema_translate_map={"tenant": schema_name})
```

**Key insight:** schema_translate_map is session-level, not connection-level.
SQLAlchemy remaps the "tenant" placeholder to the actual schema at query time.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify get_user_db() to use schema_translate_map</name>
  <files>backend/api/dependencies/__init__.py</files>
  <action>
Replace the SET LOCAL search_path approach with schema_translate_map.

Current code (lines ~410-418):
```python
db.execute(text(f"SET LOCAL search_path TO {schema_name}, public"))

# Verify search_path was applied
result = db.execute(text("SHOW search_path"))
actual_path = result.scalar()
```

Replace with:
```python
# Use schema_translate_map for robust multi-tenant isolation
# This survives COMMIT and ROLLBACK (unlike SET LOCAL search_path)
# The "tenant" placeholder in models is remapped to actual user schema
db = db.execution_options(schema_translate_map={"tenant": schema_name})

# Verify schema_translate_map was applied
schema_map = db.get_bind().execution_options.get("schema_translate_map", {})
configured_schema = schema_map.get("tenant")
```

Also update the verification check to use schema_translate_map instead of search_path.

Remove the SHOW search_path check since schema_translate_map doesn't modify search_path.
Instead, verify the execution_options were set correctly.

Update logger.debug to log schema_translate_map info instead of search_path.
  </action>
  <verify>grep "schema_translate_map" backend/api/dependencies/__init__.py returns multiple matches</verify>
  <done>get_user_db() uses schema_translate_map instead of SET LOCAL</done>
</task>

<task type="auto">
  <name>Task 2: Update verification logic for schema_translate_map</name>
  <files>backend/api/dependencies/__init__.py</files>
  <action>
Update the security verification to check schema_translate_map instead of search_path.

Current code (lines ~426-437):
```python
# Double-check schema is in path (CRITICAL SECURITY CHECK)
if schema_name not in actual_path:
    logger.critical(
        f"ðŸš¨ SEARCH_PATH FAILURE: Expected '{schema_name}' not in actual path '{actual_path}'. "
        f"User {current_user.id} isolation compromised. Closing connection."
    )
    # NE PAS continuer avec mauvais search_path - force client retry
    db.close()
    raise HTTPException(...)
```

Replace with:
```python
# Double-check schema_translate_map is set (CRITICAL SECURITY CHECK)
if configured_schema != schema_name:
    logger.critical(
        f"ðŸš¨ SCHEMA_TRANSLATE_MAP FAILURE: Expected '{schema_name}' but got '{configured_schema}'. "
        f"User {current_user.id} isolation compromised."
    )
    raise HTTPException(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        detail="Database isolation error. Please retry your request."
    )
```

Note: No need to close connection - schema_translate_map is session-level, not connection-level.
  </action>
  <verify>grep "SCHEMA_TRANSLATE_MAP FAILURE" backend/api/dependencies/__init__.py returns the check</verify>
  <done>Verification uses schema_translate_map check</done>
</task>

<task type="auto">
  <name>Task 3: Remove search_path imports and update logging</name>
  <files>backend/api/dependencies/__init__.py</files>
  <action>
Clean up the file:

1. The `text` import from sqlalchemy is still needed for _validate_schema_name DB check.
   Keep: `from sqlalchemy import text`

2. Update logger.debug message:
```python
logger.debug(
    f"[get_user_db] User {current_user.id}, "
    f"schema_translate_map={{'tenant': '{schema_name}'}}"
)
```

3. Update the docstring of get_user_db() to reflect the new implementation:
   - Remove references to "SET search_path"
   - Add explanation of schema_translate_map approach
   - Mention that this survives COMMIT/ROLLBACK
  </action>
  <verify>grep "schema_translate_map" backend/api/dependencies/__init__.py | wc -l returns >= 3</verify>
  <done>File uses schema_translate_map throughout, logging updated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `schema_translate_map` is used in get_user_db()
- [ ] No more `SET LOCAL search_path` in get_user_db()
- [ ] Security check verifies schema_translate_map
- [ ] Logging reflects new approach
- [ ] Backend starts without errors (uvicorn)
</verification>

<success_criteria>
- All 3 tasks completed
- get_user_db() uses execution_options(schema_translate_map=...)
- Security verification checks schema_translate_map
- Phase 2 complete - ready for Phase 3 (text() migration)
</success_criteria>

<output>
After completion, create `.planning/phase-2/02-02-SUMMARY.md` with:
- Duration and tasks completed
- Files modified
- Key changes (SET â†’ schema_translate_map)
- Verification that isolation still works
- Phase 2 complete, ready for Phase 3
</output>
