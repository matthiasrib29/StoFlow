---
phase: 2
plan: 01
type: execute
domain: database
---

<objective>
Ajouter les helpers schema_translate_map dans shared/database.py

Purpose: Fournir les outils n√©cessaires pour que get_user_db() utilise schema_translate_map
Output: Fonctions get_tenant_schema(), UserBase alias, et documentation
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@backend/shared/database.py

**Phase 1 complete:** All 19 tenant models have `schema="tenant"` placeholder.
**Key pattern:** `__table_args__ = {"schema": "tenant"}` for dynamic remapping.

**Current state:**
- `shared/database.py` has Base class and SET search_path functions
- `pending_instruction.py` imports `UserBase` which doesn't exist (bug to fix)
- Need to add `schema_translate_map` helpers for Phase 2 completion

**SQLAlchemy schema_translate_map pattern:**
```python
# Instead of: SET LOCAL search_path TO user_X, public
# Use: db.execution_options(schema_translate_map={"tenant": "user_X"})
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UserBase alias to shared/database.py</name>
  <files>backend/shared/database.py</files>
  <action>
Add `UserBase = Base` alias after the Base class definition.
This allows tenant models to inherit from UserBase for clarity.
Note: The alias exists for semantic purposes - models in user/ schemas should use UserBase.

Add after line ~24 (after Base class definition):
```python
# Alias for tenant models (models/user/*)
# All tenant models should inherit from UserBase for clarity
# The actual schema is set via __table_args__ = {"schema": "tenant"}
UserBase = Base
```

Also update the imports in __all__ at the end of the file to include UserBase.
  </action>
  <verify>grep "UserBase = Base" backend/shared/database.py returns the alias</verify>
  <done>UserBase alias exists and is exported</done>
</task>

<task type="auto">
  <name>Task 2: Add get_tenant_schema() helper function</name>
  <files>backend/shared/database.py</files>
  <action>
Add a helper function to extract the current tenant schema from a session using schema_translate_map.

Add after UserBase alias:
```python
def get_tenant_schema(db: Session) -> str | None:
    """
    Get tenant schema name from session's schema_translate_map.

    This function extracts the schema name that was configured via
    execution_options(schema_translate_map={"tenant": "user_X"}).

    Usage:
        schema = get_tenant_schema(db)
        # Returns "user_X" if schema_translate_map was set
        # Returns None if not using schema_translate_map

    Args:
        db: SQLAlchemy session with schema_translate_map configured

    Returns:
        Schema name (e.g., "user_123") or None if not set
    """
    # Access execution options from the session's bind
    execution_options = db.get_bind().execution_options
    schema_map = execution_options.get("schema_translate_map", {})
    return schema_map.get("tenant")
```

Note: This function is needed for Phase 3 when migrating text() queries.
  </action>
  <verify>grep "def get_tenant_schema" backend/shared/database.py returns the function</verify>
  <done>get_tenant_schema() function exists and is documented</done>
</task>

<task type="auto">
  <name>Task 3: Add deprecation warnings to SET functions</name>
  <files>backend/shared/database.py</files>
  <action>
Update docstrings of set_search_path_safe(), set_user_schema(), and set_user_search_path() to add deprecation warnings.

Add to each function's docstring:
```python
    .. deprecated:: 2026-01-13
        Use `execution_options(schema_translate_map={"tenant": schema_name})` instead.
        This function will be removed in Phase 4 of schema migration.
```

Don't remove the functions yet - they're still used by existing code until Phase 3.
  </action>
  <verify>grep -A 5 "def set_search_path_safe" backend/shared/database.py | grep "deprecated"</verify>
  <done>Deprecation warnings added to all SET functions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `UserBase = Base` alias exists in database.py
- [ ] `get_tenant_schema()` function exists and is documented
- [ ] Deprecation warnings added to SET functions
- [ ] `from shared.database import UserBase` works (fixes pending_instruction.py bug)
</verification>

<success_criteria>
- All 3 tasks completed
- UserBase import works for pending_instruction.py
- get_tenant_schema() ready for Phase 3 text() migration
- SET functions marked as deprecated
</success_criteria>

<output>
After completion, create `.planning/phase-2/02-01-SUMMARY.md` with:
- Duration and tasks completed
- Files modified
- Key decisions (if any)
- Issues encountered (if any)
- Ready for 02-02-PLAN.md
</output>
