# Plan 01-02: Modifier Modèles Secondaires

## Scope

Ajouter `__table_args__ = {"schema": "tenant"}` aux modèles **secondaires** du dossier `backend/models/user/`:
- `ebay_*.py` (5 fichiers)
- `etsy_*.py` (1 fichier)
- `ai_*.py` (1 fichier)
- `pending_instruction.py` (1 fichier)
- `product_attributes_m2m.py` (1 fichier - tables M2M)
- `publication_history.py` (1 fichier)

**Total: 10 fichiers**

## Context

Ces modèles sont utilisés moins fréquemment que les modèles principaux, mais doivent aussi avoir le placeholder schema pour garantir l'isolation multi-tenant complète.

## Tasks

### Task 1: Modifier ebay_product.py

**Files:** `backend/models/user/ebay_product.py`

**Actions:**
1. Vérifier si `__table_args__` existe
2. Ajouter `"schema": "tenant"` appropriément

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/ebay_product.py
```

---

### Task 2: Modifier ebay_credentials.py

**Files:** `backend/models/user/ebay_credentials.py`

**Actions:** Même pattern

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/ebay_credentials.py
```

---

### Task 3: Modifier ebay_order.py

**Files:** `backend/models/user/ebay_order.py`

**Actions:** Même pattern

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/ebay_order.py
```

---

### Task 4: Modifier ebay_product_marketplace.py

**Files:** `backend/models/user/ebay_product_marketplace.py`

**Actions:** Même pattern

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/ebay_product_marketplace.py
```

---

### Task 5: Modifier ebay_promoted_listing.py

**Files:** `backend/models/user/ebay_promoted_listing.py`

**Actions:** Même pattern

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/ebay_promoted_listing.py
```

---

### Task 6: Modifier etsy_credentials.py

**Files:** `backend/models/user/etsy_credentials.py`

**Actions:** Même pattern

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/etsy_credentials.py
```

---

### Task 7: Modifier ai_generation_log.py

**Files:** `backend/models/user/ai_generation_log.py`

**Actions:** Même pattern

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/ai_generation_log.py
```

---

### Task 8: Modifier pending_instruction.py

**Files:** `backend/models/user/pending_instruction.py`

**Actions:** Même pattern

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/pending_instruction.py
```

---

### Task 9: Modifier product_attributes_m2m.py

**Files:** `backend/models/user/product_attributes_m2m.py`

**Note:** Ce fichier contient **3 classes** (ProductColor, ProductMaterial, ProductConditionSup).
Chaque classe doit avoir son propre `__table_args__` avec `"schema": "tenant"`.

**Actions:**
1. Ajouter `__table_args__ = {"schema": "tenant"}` à `ProductColor`
2. Ajouter `__table_args__ = {"schema": "tenant"}` à `ProductMaterial`
3. Ajouter `__table_args__ = {"schema": "tenant"}` à `ProductConditionSup`

**Verification:**
```bash
grep -c "schema.*tenant" backend/models/user/product_attributes_m2m.py
# Doit retourner: 3
```

---

### Task 10: Modifier publication_history.py

**Files:** `backend/models/user/publication_history.py`

**Actions:** Même pattern

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/publication_history.py
```

---

## Final Verification

```bash
# Vérifier tous les fichiers secondaires
grep -l "schema.*tenant" backend/models/user/{ebay_*,etsy_*,ai_*,pending_*,product_attributes_m2m,publication_history}.py | wc -l
# Doit retourner: 10

# Vérifier le count total dans product_attributes_m2m.py
grep -c "schema.*tenant" backend/models/user/product_attributes_m2m.py
# Doit retourner: 3 (une par classe M2M)
```

## Combined Phase 1 Verification

Après Plan 01-01 et 01-02 terminés:

```bash
# Tous les 19 fichiers user/ doivent avoir schema tenant
grep -l "schema.*tenant" backend/models/user/*.py | grep -v __init__ | wc -l
# Doit retourner: 19

# Liste complète des fichiers avec schema tenant
grep -l "schema.*tenant" backend/models/user/*.py | sort
```

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Oublier une classe dans M2M file | Vérifier count = 3 pour product_attributes_m2m.py |
| Fichier sans __tablename__ | Tous les modèles ont __tablename__ défini |

## Success Criteria

- [ ] 10 fichiers modifiés (12 classes total avec M2M)
- [ ] product_attributes_m2m.py a 3 occurrences de `"schema": "tenant"`
- [ ] Aucune erreur de syntaxe Python
- [ ] Backend démarre sans erreur

## Phase 1 Complete Criteria

Après Plans 01-01 et 01-02:
- [ ] 19 fichiers dans models/user/ ont `"schema": "tenant"`
- [ ] 22 classes total ont le placeholder schema
- [ ] Backend démarre et fonctionne normalement
- [ ] Les opérations existantes continuent de fonctionner (via search_path jusqu'à Phase 2)

---

*Plan created: 2026-01-13*
