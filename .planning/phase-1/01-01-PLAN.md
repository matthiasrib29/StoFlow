# Plan 01-01: Modifier Modèles Principaux

## Scope

Ajouter `__table_args__ = {"schema": "tenant"}` (ou modifier l'existant) aux modèles **principaux** du dossier `backend/models/user/`:
- `product.py` (modèle central)
- `vinted_*.py` (5 fichiers)
- `marketplace_*.py` (2 fichiers)
- `batch_job.py` (1 fichier)

**Total: 9 fichiers**

## Context

Ces modèles sont les plus critiques car ils sont utilisés dans les opérations quotidiennes (Vinted sync, publication, jobs).

Le placeholder `"tenant"` sera remappé vers le vrai schema (`user_{id}`) via `schema_translate_map` en Phase 2.

## Tasks

### Task 1: Modifier product.py

**Files:** `backend/models/user/product.py`

**Actions:**
1. Localiser `__table_args__` existant (ligne ~86)
2. Ajouter `"schema": "tenant"` au tuple existant

**Pattern actuel:**
```python
__table_args__ = (
    CheckConstraint("stock_quantity >= 0", name="check_stock_positive"),
    Index("idx_product_brand", "brand"),
    # ... autres contraintes
)
```

**Pattern cible:**
```python
__table_args__ = (
    CheckConstraint("stock_quantity >= 0", name="check_stock_positive"),
    Index("idx_product_brand", "brand"),
    # ... autres contraintes
    {"schema": "tenant"}  # ← Ajouter en DERNIER élément du tuple
)
```

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/product.py
```

---

### Task 2: Modifier vinted_product.py

**Files:** `backend/models/user/vinted_product.py`

**Actions:**
1. Localiser `__table_args__` existant (ligne ~91)
2. Ajouter `"schema": "tenant"` au tuple existant

**Pattern cible:**
```python
__table_args__ = (
    Index('idx_vinted_products_status', 'status'),
    Index('idx_vinted_products_published_at', 'published_at'),
    Index('idx_vinted_products_brand', 'brand'),
    Index('idx_vinted_products_catalog_id', 'catalog_id'),
    Index('idx_vinted_products_seller_id', 'seller_id'),
    {"schema": "tenant"}  # ← Ajouter
)
```

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/vinted_product.py
```

---

### Task 3: Modifier vinted_connection.py

**Files:** `backend/models/user/vinted_connection.py`

**Actions:**
1. Vérifier si `__table_args__` existe
2. Si non: ajouter `__table_args__ = {"schema": "tenant"}`
3. Si oui: ajouter `"schema": "tenant"` au tuple

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/vinted_connection.py
```

---

### Task 4: Modifier vinted_conversation.py

**Files:** `backend/models/user/vinted_conversation.py`

**Actions:** Même pattern que Task 3

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/vinted_conversation.py
```

---

### Task 5: Modifier vinted_error_log.py

**Files:** `backend/models/user/vinted_error_log.py`

**Actions:** Même pattern que Task 3

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/vinted_error_log.py
```

---

### Task 6: Modifier vinted_job_stats.py

**Files:** `backend/models/user/vinted_job_stats.py`

**Actions:** Même pattern que Task 3

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/vinted_job_stats.py
```

---

### Task 7: Modifier marketplace_job.py

**Files:** `backend/models/user/marketplace_job.py`

**Actions:**
1. Le fichier n'a PAS de `__table_args__` défini
2. Ajouter après `__tablename__`:
```python
__tablename__ = "marketplace_jobs"
__table_args__ = {"schema": "tenant"}
```

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/marketplace_job.py
```

---

### Task 8: Modifier marketplace_task.py

**Files:** `backend/models/user/marketplace_task.py`

**Actions:** Même pattern que Task 7

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/marketplace_task.py
```

---

### Task 9: Modifier batch_job.py

**Files:** `backend/models/user/batch_job.py`

**Actions:**
1. Le fichier n'a PAS de `__table_args__` défini
2. Ajouter après `__tablename__`:
```python
__tablename__ = "batch_jobs"
__table_args__ = {"schema": "tenant"}
```

**Verification:**
```bash
grep -n "schema.*tenant" backend/models/user/batch_job.py
```

---

## Final Verification

```bash
# Vérifier que tous les 9 fichiers ont le schema tenant
grep -l "schema.*tenant" backend/models/user/{product,vinted_*,marketplace_*,batch_job}.py | wc -l
# Doit retourner: 9
```

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Syntaxe incorrecte du tuple | Vérifier que `{"schema": "tenant"}` est le DERNIER élément |
| Import manquant | Aucun import nécessaire - dict natif Python |
| Tests cassés | Les tests utilisent aussi search_path - fonctionneront jusqu'à Phase 2 |

## Success Criteria

- [ ] 9 fichiers modifiés avec `"schema": "tenant"`
- [ ] Aucune erreur de syntaxe Python
- [ ] Backend démarre sans erreur (`uvicorn main:app --reload`)

---

*Plan created: 2026-01-13*
