---
phase: 3
plan: 02
status: pending
estimated: 20 min
---

# Plan 03-02: Migrate Services (schema_utils → schema_translate_map)

## Goal

Replace all usage of `shared/schema_utils.py` functions in services with the new `schema_translate_map` approach. Services that need the tenant schema name can use `get_tenant_schema(db)` from `shared/database.py`.

## Context

**Functions being replaced:**
- `restore_search_path()` - No longer needed
- `restore_search_path_after_rollback()` - Simplified to just rollback
- `commit_and_restore_path()` - Simplified to just commit
- `SchemaManager` class - No longer needed
- `get_current_schema()` - Replace with `get_tenant_schema(db)`

**Why replacement is simpler:**
- `schema_translate_map` is attached to the session, not the PostgreSQL connection
- It survives COMMIT and ROLLBACK automatically
- No need for capture/restore patterns

## Files to Modify

### 1. services/vinted/vinted_product_enricher.py
**Current usage:**
- Line 26: `from shared.schema_utils import restore_search_path_after_rollback, commit_and_restore_path`
- Line 130: `restore_search_path_after_rollback(db, f"user_{self.user_id}")`
- Line 191: `commit_and_restore_path(db)`

**Changes:**
- Remove import of `restore_search_path_after_rollback, commit_and_restore_path`
- Line 130: Replace with simple `db.rollback()` (schema is preserved)
- Line 191: Replace with simple `db.commit()` (schema is preserved)

### 2. services/vinted/vinted_api_sync.py
**Current usage:**
- Line 51: `from shared.schema_utils import restore_search_path_after_rollback, commit_and_restore_path`
- Line 129: `commit_and_restore_path(db)`
- Line 138: `restore_search_path_after_rollback(db)`

**Changes:**
- Remove import
- Line 129: Replace with `db.commit()`
- Line 138: Replace with `db.rollback()`

### 3. services/vinted/vinted_order_sync.py
**Current usage:**
- Line 25: `from shared.schema_utils import SchemaManager, commit_and_restore_path`
- Line 54: `self._schema_manager = SchemaManager()`
- Lines 186, 373, 489: `commit_and_restore_path(db)`

**Changes:**
- Remove import of `SchemaManager, commit_and_restore_path`
- Remove `self._schema_manager` attribute
- Replace all `commit_and_restore_path(db)` with `db.commit()`

### 4. services/vinted/vinted_inbox_sync_service.py
**Current usage:**
- Line 20: `from shared.schema_utils import SchemaManager`
- Line 39: `self._schema_manager = SchemaManager()`

**Changes:**
- Remove import of `SchemaManager`
- Remove `self._schema_manager` attribute

### 5. services/vinted/vinted_conversation_service.py
**Current usage:**
- Line 32: `from shared.schema_utils import SchemaManager, commit_and_restore_path`
- Line 59: `self._schema_manager = SchemaManager()`
- Line 218: `commit_and_restore_path(db)`

**Changes:**
- Remove import
- Remove `self._schema_manager` attribute
- Line 218: Replace with `db.commit()`

### 6. services/marketplace/marketplace_job_processor.py
**Current usage:**
- Line 190: `from shared.schema_utils import restore_search_path_after_rollback`
- Line 193: `restore_search_path_after_rollback(self.db, f"user_{self.user_id}")`

**Changes:**
- Remove dynamic import
- Line 193: Replace with simple `self.db.rollback()` (schema is preserved)

### 7. services/marketplace/handlers/vinted/link_product_handler.py
**Current usage:**
- Line 27: `from shared.schema_utils import get_current_schema`

**Changes:**
- Replace import: `from shared.database import get_tenant_schema`
- Update usage to `get_tenant_schema(db)` instead of `get_current_schema(db)`

### 8. services/vinted/jobs/link_product_job_handler.py
**Current usage:**
- Line 24: `from shared.schema_utils import get_current_schema`

**Changes:**
- Replace import: `from shared.database import get_tenant_schema`
- Update usage to `get_tenant_schema(db)` instead of `get_current_schema(db)`

## Tasks

- [ ] **Task 1**: Modify `services/vinted/vinted_product_enricher.py`
  - Remove schema_utils import
  - Replace line 130 with `db.rollback()`
  - Replace line 191 with `db.commit()`

- [ ] **Task 2**: Modify `services/vinted/vinted_api_sync.py`
  - Remove schema_utils import
  - Replace line 129 with `db.commit()`
  - Replace line 138 with `db.rollback()`

- [ ] **Task 3**: Modify `services/vinted/vinted_order_sync.py`
  - Remove SchemaManager import and attribute
  - Replace all `commit_and_restore_path(db)` with `db.commit()`

- [ ] **Task 4**: Modify `services/vinted/vinted_inbox_sync_service.py`
  - Remove SchemaManager import and attribute

- [ ] **Task 5**: Modify `services/vinted/vinted_conversation_service.py`
  - Remove SchemaManager import and attribute
  - Replace `commit_and_restore_path(db)` with `db.commit()`

- [ ] **Task 6**: Modify `services/marketplace/marketplace_job_processor.py`
  - Remove dynamic import of `restore_search_path_after_rollback`
  - Replace with simple `self.db.rollback()`

- [ ] **Task 7**: Modify handler files (link_product_handler.py, link_product_job_handler.py)
  - Replace `from shared.schema_utils import get_current_schema`
  - With `from shared.database import get_tenant_schema`
  - Update usage

- [ ] **Task 8**: Verify changes
  ```bash
  grep -r "from shared.schema_utils import" backend/services/ --include="*.py"
  ```

- [ ] **Task 9**: Commit changes
  ```
  feat(03-02): remove deprecated schema_utils from services

  Services no longer need manual schema restoration with schema_translate_map.
  - commit_and_restore_path() → db.commit()
  - restore_search_path_after_rollback() → db.rollback()
  - SchemaManager → removed
  - get_current_schema() → get_tenant_schema()
  ```

## Verification

After completion:
```bash
# Should return 0 matches in services (excluding tests)
grep -r "from shared.schema_utils import" backend/services/ --include="*.py" | grep -v "test_"

# Verify commit/rollback calls work correctly
grep -r "db.commit()\|db.rollback()" backend/services/vinted/ --include="*.py" | head -20
```

## Rollback

If issues occur:
1. Revert commit with `git revert`
2. Restore schema_utils imports and calls
3. Report issue for investigation

---
*Plan: 03-02*
*Created: 2026-01-13*
