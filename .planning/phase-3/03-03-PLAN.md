---
phase: 3
plan: 03
status: pending
estimated: 25 min
---

# Plan 03-03: Migrate Schedulers, Scripts & Remaining Files

## Goal

Migrate remaining files that use direct `SET search_path` SQL statements or deprecated functions. These files iterate through user schemas independently (not using `get_user_db()`) and need special handling.

## Context

**Two patterns to handle:**

1. **Files using `get_user_db()` dependency** (covered in 03-01, 03-02)
   - Already use `schema_translate_map` from Phase 2
   - Just need cleanup of deprecated function calls

2. **Files iterating through schemas manually** (this plan)
   - Schedulers, scripts, cron jobs
   - Create their own sessions
   - Need direct `SET search_path` â†’ `execution_options(schema_translate_map=...)`

**Strategy for manual iteration:**
```python
# BEFORE (fragile)
db.execute(text(f"SET LOCAL search_path TO {schema}, public"))

# AFTER (robust)
db = db.execution_options(schema_translate_map={"tenant": schema})
```

## Files to Modify

### Category A: Schedulers (iterate through all user schemas)

#### 1. services/marketplace/job_cleanup_scheduler.py
**Current usage:**
- Line 102: `db.execute(text(f"SET LOCAL search_path TO {schema}, public"))`

**Strategy:** This scheduler iterates all user schemas for cleanup. Since it creates its own session and iterates schemas, we need to use `execution_options` for each schema.

**Changes:**
```python
# BEFORE
db.execute(text(f"SET LOCAL search_path TO {schema}, public"))

# AFTER
# For schedulers that iterate schemas, use execution_options per iteration
schema_db = db.execution_options(schema_translate_map={"tenant": schema})
# Use schema_db for queries in this schema
```

**Note:** This scheduler queries `information_schema` and doesn't use ORM models with `schema="tenant"`. The `SET LOCAL` might actually be appropriate here. **Review needed** - may just need to remove the call entirely since queries are schema-qualified.

#### 2. services/datadome_scheduler.py
**Current usage:**
- Line 95: `db.execute(text(f"SET LOCAL search_path TO {schema}, public"))`

**Similar to job_cleanup_scheduler** - needs review.

#### 3. services/etsy_polling_cron.py
**Current usage:**
- Line 43: `from shared.database import set_user_schema`
- Line 86: `set_user_schema(db, user.id)`
- Line 103: `db.execute(text("SET search_path TO public"))`

**Changes:**
- Replace `set_user_schema(db, user.id)` with `db = db.execution_options(schema_translate_map={"tenant": f"user_{user.id}"})`
- Remove "SET search_path TO public" (not needed)

### Category B: API files with direct SET (not using get_user_db pattern)

#### 4. api/products/ai.py
**Current usage:**
- Line 82: `db.execute(text(f"SET search_path TO {current_user.schema_name}, public"))`

**Changes:**
- This endpoint likely gets db from `get_user_db()` already configured
- Remove the manual SET call (redundant)

#### 5. api/ebay/products.py (MAJOR - many instances)
**Current usage:**
- Multiple lines with `db.execute(text(f"SET search_path TO {schema_name}, public"))`
- Lines: 246, 274, 309, 312, 352, 432, 450, 469, 478, 498, 528, 547, 560

**Analysis needed:** This file has MANY direct SET calls. Need to understand:
- Are these using `get_user_db()` already?
- Or creating their own sessions?

**Likely changes:**
- If using `get_user_db()`: Remove all SET calls (already configured)
- If creating own sessions: Use `execution_options` pattern

### Category C: Scripts (one-time or maintenance)

#### 6. scripts/cleanup_abandoned_drafts.py
**Current usage:**
- Line 70: `db.execute(text(f"SET search_path TO {schema}, public"))`
- Line 125: `db.execute(text("SET search_path TO public"))`

**Changes:**
- Replace with `execution_options` pattern for schema iteration
- Remove "SET search_path TO public" calls

#### 7. scripts/migrate_existing_jobs_to_batch.py
**Current usage:**
- Line 154: `db.execute(text(f"SET search_path TO {schema_name}, public"))`

**Changes:**
- Replace with `execution_options` pattern

#### 8. scripts/migrate_oauth_tokens_encryption.py
**Current usage:**
- Line 49: `db.execute(text(f"SET search_path TO {schema}, public"))`
- Line 88: `db.execute(text(f"SET search_path TO {schema}, public"))`

**Changes:**
- Replace with `execution_options` pattern

#### 9. scripts/migrate_from_pythonapiwoo.py
**Current usage:**
- Line 430: `target_session.execute(text("SET search_path TO user_1, public"))`

**Changes:**
- Replace with `execution_options` pattern

### Category D: eBay handler

#### 10. services/ebay/jobs/ebay_orders_sync_job_handler.py
**Current usage:**
- Line 83-84: `from shared.database import set_user_schema` + `set_user_schema(self.db, self.shop_id)`

**Changes:**
- This handler receives a db session already configured from MarketplaceJobProcessor
- Remove the `set_user_schema` call (redundant)

### Category E: Test file (leave as-is)

#### 11. test_ai_credits.py
- Line 31: `db.execute(text("SET search_path TO public"))`
- **Decision:** Leave test files as-is (Phase 5 will handle tests)

## Tasks

- [ ] **Task 1**: Review and modify schedulers
  - `job_cleanup_scheduler.py` - Review if SET is needed
  - `datadome_scheduler.py` - Review if SET is needed
  - `etsy_polling_cron.py` - Replace with execution_options

- [ ] **Task 2**: Modify `api/products/ai.py`
  - Remove redundant SET call

- [ ] **Task 3**: Analyze and modify `api/ebay/products.py`
  - Analyze usage pattern
  - Remove or replace SET calls as appropriate

- [ ] **Task 4**: Modify `services/ebay/jobs/ebay_orders_sync_job_handler.py`
  - Remove redundant `set_user_schema` call

- [ ] **Task 5**: Modify scripts (low priority - one-time use)
  - `cleanup_abandoned_drafts.py`
  - `migrate_existing_jobs_to_batch.py`
  - `migrate_oauth_tokens_encryption.py`
  - `migrate_from_pythonapiwoo.py`

- [ ] **Task 6**: Verify changes
  ```bash
  # Should return only: migrations/env.py, shared/database.py, shared/schema_utils.py, tests/*
  grep -r "SET.*search_path" backend/ --include="*.py" | grep -v "migrations/" | grep -v "test" | grep -v "shared/"
  ```

- [ ] **Task 7**: Commit changes
  ```
  feat(03-03): migrate schedulers and scripts to schema_translate_map

  Replace direct SET search_path SQL with schema_translate_map pattern
  in schedulers, scripts, and remaining API files.
  ```

## Important Notes

### Scheduler Pattern
For schedulers that iterate all user schemas:
```python
# Pattern for schema iteration with schema_translate_map
for schema in get_all_user_schemas(db):
    # Create a scoped session with the right schema mapping
    schema_db = db.execution_options(schema_translate_map={"tenant": schema})

    # Use schema_db for all queries
    jobs = schema_db.query(MarketplaceJob).filter(...).all()
```

### When SET search_path is still valid
Some files query `information_schema` which is in PostgreSQL system catalog. These queries don't use ORM models with `schema="tenant"`, so `schema_translate_map` won't help. For these cases:
- If query is fully schema-qualified (e.g., `SELECT * FROM information_schema.tables WHERE table_schema = '{schema}'`), SET is not needed
- If query references unqualified table names, keep SET or qualify the table names

## Verification

```bash
# Count remaining SET search_path usages (excluding migrations, tests, shared)
grep -r "SET.*search_path" backend/ --include="*.py" | \
  grep -v "migrations/" | grep -v "test" | grep -v "shared/" | \
  grep -v "\.pyc" | wc -l

# Should be 0 or only documented exceptions
```

## Rollback

If issues occur:
1. Revert commit with `git revert`
2. Restore SET search_path calls
3. Report issue for investigation

---
*Plan: 03-03*
*Created: 2026-01-13*
