---
phase: 3
plan: 01
status: completed
estimated: 15 min
actual: 14 min
completed: 2026-01-13
---

# Plan 03-01: Migrate API Files (set_user_search_path → schema_translate_map)

## Goal

Remove all `set_user_search_path()` calls from API files. With `schema_translate_map` now set in `get_user_db()`, these calls are no longer needed - the schema isolation is persistent across COMMIT/ROLLBACK.

## Context

**Why these calls existed:**
- `SET LOCAL search_path` was lost after `db.commit()`
- Developers had to manually call `set_user_search_path()` after each commit

**Why they're no longer needed:**
- `schema_translate_map` persists across COMMIT and ROLLBACK
- The session from `get_user_db()` is already configured for the user's schema

## Files to Modify

### 1. api/vinted/products.py
**Current usage:**
- Line 53: `from shared.database import set_user_search_path`
- Line 249: `set_user_search_path(db, current_user.id)  # Re-set after commit`
- Line 314: `set_user_search_path(db, current_user.id)  # Re-set after commit`

**Changes:**
- Remove import of `set_user_search_path`
- Remove both `set_user_search_path()` calls after commits

### 2. api/vinted/publishing.py
**Current usage:**
- Line 21: `from shared.database import set_user_search_path`
- Line 66: `set_user_search_path(db, current_user.id)  # Re-set after commit`

**Changes:**
- Remove import of `set_user_search_path`
- Remove `set_user_search_path()` call after commit

### 3. api/vinted/orders.py
**Current usage:**
- Line 31: `from shared.database import set_user_search_path`
- Line 147: `set_user_search_path(db, current_user.id)  # Re-set after commit`

**Changes:**
- Remove import of `set_user_search_path`
- Remove `set_user_search_path()` call after commit

### 4. api/vinted/messages.py
**Current usage:**
- Line 27: `from shared.database import set_user_search_path`
- Line 151: `set_user_search_path(db, current_user.id)  # Re-set after commit`

**Changes:**
- Remove import of `set_user_search_path`
- Remove `set_user_search_path()` call after commit

### 5. api/ebay/orders.py
**Current usage:**
- Line 44: `from shared.database import set_user_search_path`
- Line 141: `set_user_search_path(db, current_user.id)  # Re-set after commit`
- Line 151: `from shared.database import set_user_schema` (dynamic import in except block)

**Changes:**
- Remove import of `set_user_search_path`
- Remove `set_user_search_path()` call after commit
- Remove dynamic import of `set_user_schema` in except block

### 6. api/ebay/products.py
**Current usage:**
- Line 26: `from shared.database import set_user_schema, SessionLocal`

**Changes:**
- Remove `set_user_schema` from import (keep `SessionLocal` if used)

## Tasks

- [x] **Task 1**: Modify `api/vinted/products.py` ✅
  - Remove import line 53
  - Remove calls at lines 249 and 314

- [x] **Task 2**: Modify `api/vinted/publishing.py` ✅
  - Remove import line 21
  - Remove call at line 66

- [x] **Task 3**: Modify `api/vinted/orders.py` ✅
  - Remove import line 31
  - Remove call at line 147

- [x] **Task 4**: Modify `api/vinted/messages.py` ✅
  - Remove import line 27
  - Remove call at line 151

- [x] **Task 5**: Modify `api/ebay/orders.py` ✅
  - Remove import line 44
  - Remove call at line 141
  - Remove dynamic import at line 151

- [x] **Task 6**: Modify `api/ebay/products.py` ✅
  - Remove `set_user_schema` from import line 26

- [x] **Task 7**: Verify changes ✅
  ```bash
  grep -r "set_user_search_path\|set_user_schema" backend/api/ --include="*.py"
  # Result: No matches found
  ```

- [x] **Task 8**: Commit changes ✅
  ```
  feat(03-01): remove deprecated set_user_search_path from API files

  With schema_translate_map now persistent across COMMIT/ROLLBACK,
  manual search_path restoration is no longer needed in API routes.
  ```
  Commit: `917c8bc`

## Verification

After completion:
```bash
# Should return 0 matches (excluding test files)
grep -r "set_user_search_path\|set_user_schema" backend/api/ --include="*.py" | grep -v "test_"

# Should return 0 matches
grep -r "from shared.database import.*set_user" backend/api/ --include="*.py"
```

## Rollback

If issues occur:
1. Revert commit with `git revert`
2. Add back `set_user_search_path()` calls after commits
3. Report issue for investigation

---
*Plan: 03-01*
*Created: 2026-01-13*
