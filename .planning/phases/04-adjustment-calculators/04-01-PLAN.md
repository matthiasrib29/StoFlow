---
phase: 04-adjustment-calculators
plan: 01
type: tdd
---

<objective>
Implement Model Coefficient and Condition Adjustment calculators using TDD.

Purpose: Create the foundation adjustment calculators - model coefficient (simple multiplier) and condition adjustment (score-based with caps). These are the most straightforward calculators and establish testing patterns for the remaining adjustments.

Output: Two fully tested calculator functions with comprehensive edge case coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase dependencies:**
- Phase 1: Database foundation (BrandGroup, Model tables)
- Phase 2: Group determination logic
- Phase 3: LLM generation service (can generate BrandGroup/Model data)

**Established patterns:**
- Python Decimal for precision
- Pytest for unit testing
- Type hints with Pydantic validation
- Services in `backend/services/pricing/`
- Tests in `backend/tests/unit/services/pricing/`

**Tech stack available:**
- Python 3.11+
- Decimal (standard library)
- Pytest with pytest-asyncio
- Pydantic for validation

**Formulas specified in ROADMAP:**

1. **Model Coefficient** (simple):
   - Input: Model object with coefficient field
   - Output: Decimal coefficient (0.5-3.0 range)
   - Logic: Return model.coefficient directly

2. **Condition Adjustment** (complex):
   - Input: condition_score (0-5), supplements (list), condition_sensitivity (0.5-1.5)
   - Output: Decimal adjustment (-0.30 to +0.30)
   - Base formula: `(score - 3.0) / 10.0 * sensitivity`
   - Supplement bonuses: sum of supplement values
   - Cap: final result capped at ±0.30
</context>

<feature>
  <name>calculateModelCoefficient</name>
  <files>
    - backend/services/pricing/adjustment_calculators.py
    - backend/tests/unit/services/pricing/test_adjustment_calculators.py
  </files>
  <behavior>
    Simple multiplier extraction from Model entity.

    Cases:
    - Model with coefficient=1.5 → 1.5
    - Model with coefficient=0.5 (min) → 0.5
    - Model with coefficient=3.0 (max) → 3.0
    - Model with coefficient=1.0 (neutral) → 1.0

    Edge cases:
    - Model is None → Should raise ValueError
    - Model.coefficient is None → Should raise ValueError
  </behavior>
  <implementation>
    Create `backend/services/pricing/adjustment_calculators.py` with:
    - Function signature: `def calculateModelCoefficient(model: Optional[Model]) -> Decimal`
    - Validation: raise ValueError if model is None or coefficient is None
    - Return: model.coefficient directly (already validated by Model CHECK constraint)
    - Type hints: use typing.Optional, models.public.model.Model
  </implementation>
</feature>

<feature>
  <name>calculateConditionAdjustment</name>
  <files>
    - backend/services/pricing/adjustment_calculators.py (extend)
    - backend/tests/unit/services/pricing/test_adjustment_calculators.py (extend)
  </files>
  <behavior>
    Score-based adjustment with supplement bonuses and caps.

    Base calculation cases (no supplements, sensitivity=1.0):
    - score=5 (perfect) → +0.20 (capped at +0.30)
    - score=4 (excellent) → +0.10
    - score=3 (good, baseline) → 0.00
    - score=2 (fair) → -0.10
    - score=1 (poor) → -0.20
    - score=0 (damaged) → -0.30 (capped at -0.30)

    Sensitivity scaling cases (score=4, no supplements):
    - sensitivity=0.5 → +0.05 (half sensitivity)
    - sensitivity=1.0 → +0.10 (neutral)
    - sensitivity=1.5 → +0.15 (high sensitivity)

    Supplement bonus cases (score=3, sensitivity=1.0):
    - supplements=["original_box"] (+0.05) → +0.05
    - supplements=["original_box", "tags"] (+0.05 + 0.03) → +0.08
    - Empty supplements → 0.00

    Capping cases:
    - score=5 + high sensitivity + bonuses → should cap at +0.30
    - score=0 + low sensitivity → should cap at -0.30

    Edge cases:
    - score < 0 or > 5 → Should raise ValueError
    - sensitivity < 0.5 or > 1.5 → Should raise ValueError
    - supplements with unknown keys → Should ignore or raise ValueError
  </behavior>
  <implementation>
    Add to `backend/services/pricing/adjustment_calculators.py`:
    - Function signature: `def calculateConditionAdjustment(condition_score: int, supplements: list[str], condition_sensitivity: Decimal) -> Decimal`
    - Constants dict: SUPPLEMENT_VALUES = {"original_box": 0.05, "tags": 0.03, "dust_bag": 0.03, "authenticity_card": 0.04}
    - Validation: score in [0-5], sensitivity in [0.5-1.5]
    - Base calculation: `(score - 3.0) / 10.0 * sensitivity`
    - Supplement sum: iterate supplements, sum known values, ignore unknown
    - Final: `base + supplement_sum`, capped at ±0.30
    - Return: Decimal with 2 decimal places
  </implementation>
</feature>

<verification>
All tests pass:
```bash
pytest backend/tests/unit/services/pricing/test_adjustment_calculators.py -v
```

Expected test classes:
- TestCalculateModelCoefficient (5-7 tests)
- TestCalculateConditionAdjustment (15-20 tests covering all cases)
</verification>

<success_criteria>
- RED phase: Failing tests written for both calculators
- GREEN phase: Implementation passes all tests
- REFACTOR phase: Code cleaned if needed (optional)
- All tests pass
- Code committed with TDD commit pattern (test → feat → refactor)
- Comprehensive edge case coverage
</success_criteria>

<output>
After completion, create `.planning/phases/04-adjustment-calculators/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Model Coefficient & Condition Adjustment Summary

**TDD implementation of model coefficient and condition adjustment calculators with comprehensive test coverage**

## TDD Cycle

### RED Phase
- Tests written for calculateModelCoefficient (5-7 tests)
- Tests written for calculateConditionAdjustment (15-20 tests)
- All tests initially failing

### GREEN Phase
- calculateModelCoefficient implemented (simple extraction)
- calculateConditionAdjustment implemented (score + supplements + cap)
- All tests passing

### REFACTOR Phase
- [If any refactoring done, describe it]
- [Or: "No refactoring needed - implementation clean"]

## Commits
- `test(04-01): add failing tests for model coefficient calculator` - [hash]
- `feat(04-01): implement calculateModelCoefficient` - [hash]
- `test(04-01): add failing tests for condition adjustment calculator` - [hash]
- `feat(04-01): implement calculateConditionAdjustment with caps and supplements` - [hash]
- [Optional] `refactor(04-01): [description]` - [hash]

## Files Created/Modified
- `backend/services/pricing/adjustment_calculators.py` - Calculator functions
- `backend/tests/unit/services/pricing/test_adjustment_calculators.py` - Test suite

## Next Step
Ready for 04-02-PLAN.md (Origin & Decade Adjustments)
</output>
