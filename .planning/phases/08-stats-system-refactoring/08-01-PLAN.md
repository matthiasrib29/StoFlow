---
phase: 08-stats-system-refactoring
plan: 01
type: execute
---

<objective>
Refactor the statistics tracking system to be marketplace-agnostic, separating stats per marketplace instead of mixing all marketplaces in `vinted_job_stats`.

Purpose: Enable proper analytics per marketplace (Vinted, eBay, Etsy) and remove naming confusion.
Output: Renamed table `marketplace_job_stats` with `marketplace` column, updated services and queries.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Current Architecture (Problem)

**Table**: `user_X.vinted_job_stats`
- Used by ALL marketplaces (Vinted, eBay, Etsy)
- Naming is misleading (implies Vinted-only)
- No `marketplace` column to distinguish sources

**Usage**:
- `MarketplaceJobService.update_job_stats()` writes to `vinted_job_stats` for ALL marketplaces
- `MarketplaceJobService.get_stats()` reads from `vinted_job_stats`
- `VintedJobStatsService` (dedicated service) also uses same table
- Frontend queries don't filter by marketplace

**Files Affected**:
- Model: `backend/models/user/vinted_job_stats.py` (85 lines)
- Services:
  - `backend/services/marketplace/marketplace_job_service.py` (uses VintedJobStats)
  - `backend/services/vinted/vinted_job_stats_service.py` (200 lines)
- Migration: New Alembic migration needed
- Tests: `backend/tests/unit/models/test_vinted_job_models.py`

## Target Architecture (Solution)

**Table**: `user_X.marketplace_job_stats`
- Renamed from `vinted_job_stats`
- New column: `marketplace` ENUM('vinted', 'ebay', 'etsy')
- New unique constraint: `(action_type_id, marketplace, date)`
- New index: `(marketplace, created_at)` for queries

**Model**: `MarketplaceJobStats` (replaces `VintedJobStats`)
- SQLAlchemy enum for marketplace field
- Updated unique constraint
- Keep same metrics (total_jobs, success_count, failure_count, avg_duration_ms)

**Services**:
- `MarketplaceJobService.update_job_stats()` → adds marketplace parameter
- `MarketplaceJobService.get_stats()` → filters by marketplace
- `VintedJobStatsService` → becomes `MarketplaceJobStatsService` (or deprecate entirely)

## Key Decisions from Previous Phases

**Phase 1-7 Foundation**:
- MarketplaceTask system active
- All handlers delegate to services
- eBay/Etsy handlers factorized via DirectAPIJobHandler
- Vinted handlers refactored (3 core handlers thin)

**Stats Usage**:
- Currently tracked: success/failure rates, avg duration per action type
- Used for: Frontend analytics dashboard, monitoring alerts
- Frequency: Updated after each job completion (real-time)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Alembic migration to rename table and add marketplace column</name>
  <files>backend/migrations/versions/YYYYMMDD_HHMM_rename_vinted_job_stats_to_marketplace.py</files>
  <action>
Create Alembic migration with:

1. Rename table: `vinted_job_stats` → `marketplace_job_stats`
2. Add `marketplace` column:
   - Type: VARCHAR(20) NOT NULL
   - Check constraint: marketplace IN ('vinted', 'ebay', 'etsy')
   - Default: 'vinted' (for existing rows)
3. Drop old unique constraint: `uq_vinted_job_stats_action_date`
4. Add new unique constraint: `uq_marketplace_job_stats_action_marketplace_date` on (action_type_id, marketplace, date)
5. Add index: `ix_marketplace_job_stats_marketplace_created_at` on (marketplace, created_at)

Migration must be:
- Multi-tenant safe (runs on all user_X schemas via schema_translate_map)
- Reversible (downgrade should work)
- Preserves existing data (all current rows get marketplace='vinted')

Use Alembic batch operations for SQLite compatibility (even though we use Postgres, it's best practice):
```python
with op.batch_alter_table('vinted_job_stats', schema='tenant') as batch_op:
    batch_op.alter_column('table_name', new_column_name='marketplace_job_stats')
```

**Avoid**: Dropping the table and recreating (would lose data). Use ALTER TABLE.
  </action>
  <verify>
```bash
cd backend
alembic upgrade head  # Should succeed without errors
alembic current  # Should show new migration applied
```

Verify in DB:
```sql
-- Check table exists
SELECT * FROM user_1.marketplace_job_stats LIMIT 1;

-- Check marketplace column exists with constraint
\d user_1.marketplace_job_stats

-- Verify existing data preserved (all should have marketplace='vinted')
SELECT DISTINCT marketplace FROM user_1.marketplace_job_stats;
```
  </verify>
  <done>
- Migration file created in `backend/migrations/versions/`
- Migration applies cleanly on test database
- Table renamed to `marketplace_job_stats`
- Column `marketplace` added with check constraint
- New unique constraint and index created
- Existing rows have `marketplace='vinted'`
- Migration is reversible (downgrade tested)
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor MarketplaceJobStats model (rename from VintedJobStats)</name>
  <files>backend/models/user/marketplace_job_stats.py (renamed from vinted_job_stats.py), backend/models/user/__init__.py</files>
  <action>
1. Rename file: `vinted_job_stats.py` → `marketplace_job_stats.py`

2. Rename class: `VintedJobStats` → `MarketplaceJobStats`

3. Add marketplace field:
```python
from enum import Enum as PyEnum

class MarketplaceEnum(str, PyEnum):
    """Marketplace types for job stats."""
    VINTED = "vinted"
    EBAY = "ebay"
    ETSY = "etsy"

class MarketplaceJobStats(Base):
    __tablename__ = "marketplace_job_stats"
    __table_args__ = (
        UniqueConstraint("action_type_id", "marketplace", "date",
                         name="uq_marketplace_job_stats_action_marketplace_date"),
        {"schema": "tenant"},
    )

    # ... existing fields ...

    marketplace: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        index=True,
        comment="Marketplace: vinted, ebay, etsy"
    )
```

4. Update docstring to reflect marketplace-agnostic purpose

5. Keep existing fields unchanged: id, action_type_id, date, total_jobs, success_count, failure_count, avg_duration_ms, created_at

6. Update `__init__.py` imports:
```python
from models.user.marketplace_job_stats import MarketplaceJobStats  # renamed from VintedJobStats
```

**Avoid**: Changing field types or removing fields (would break existing queries).
  </action>
  <verify>
```bash
cd backend
python -c "from models.user.marketplace_job_stats import MarketplaceJobStats; print(MarketplaceJobStats.__tablename__)"
# Should print: marketplace_job_stats

python -c "from models.user import MarketplaceJobStats; print('Import OK')"
# Should print: Import OK
```
  </verify>
  <done>
- File renamed to `marketplace_job_stats.py`
- Class renamed to `MarketplaceJobStats`
- `marketplace` field added with Enum type
- Unique constraint updated in model
- `__init__.py` updated with new import
- No Python import errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Update MarketplaceJobService to use new model and pass marketplace parameter</name>
  <files>backend/services/marketplace/marketplace_job_service.py</files>
  <action>
1. Update imports:
```python
from models.user.marketplace_job_stats import MarketplaceJobStats  # renamed from VintedJobStats
```

2. Update `update_job_stats()` method:
   - Add `marketplace: str` parameter (required)
   - Change all references from `VintedJobStats` to `MarketplaceJobStats`
   - Add `marketplace` to filter query:
```python
stats = (
    self.db.query(MarketplaceJobStats)
    .filter(
        MarketplaceJobStats.action_type_id == job.action_type_id,
        MarketplaceJobStats.marketplace == marketplace,  # NEW
        MarketplaceJobStats.date == today,
    )
    .first()
)
```
   - Add `marketplace` when creating new stats record:
```python
stats = MarketplaceJobStats(
    action_type_id=job.action_type_id,
    marketplace=marketplace,  # NEW
    date=today,
    total_jobs=0,
    success_count=0,
    failure_count=0,
)
```

3. Update `get_stats()` method:
   - Add optional `marketplace: str | None = None` parameter
   - If marketplace provided, filter by it:
```python
query = self.db.query(MarketplaceJobStats).filter(MarketplaceJobStats.date >= start_date)
if marketplace:
    query = query.filter(MarketplaceJobStats.marketplace == marketplace)
query = query.order_by(MarketplaceJobStats.date.desc())
```

4. Find all calls to `update_job_stats()` in this file and add marketplace:
   - Look for patterns like: `self.update_job_stats(job, success=True)`
   - Determine marketplace from job.marketplace or job.action_type (if action_type is FK to vinted/ebay/etsy tables)
   - For now, hardcode based on context (Vinted jobs → 'vinted', etc.)

**Avoid**: Trying to auto-detect marketplace from action_type_id (FK to vinted.action_types) - this won't work for eBay/Etsy which may use different FK tables. Explicitly pass marketplace string.
  </action>
  <verify>
```bash
cd backend
python -c "from services.marketplace.marketplace_job_service import MarketplaceJobService; print('Import OK')"
# Should succeed

# Check no references to old VintedJobStats
grep -r "VintedJobStats" backend/services/marketplace/ || echo "No old references found"
```
  </verify>
  <done>
- Imports updated to use `MarketplaceJobStats`
- `update_job_stats()` accepts `marketplace` parameter
- Filter queries include `marketplace` field
- New stats records include `marketplace` field
- `get_stats()` supports optional marketplace filter
- All calls to `update_job_stats()` pass marketplace
- No references to old `VintedJobStats` class
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Migration applies cleanly (`alembic upgrade head`)
- [ ] Table renamed to `marketplace_job_stats` in database
- [ ] Model renamed to `MarketplaceJobStats` in code
- [ ] No import errors (`python -c "from models.user import MarketplaceJobStats"`)
- [ ] Services use new model (no references to `VintedJobStats` in marketplace services)
- [ ] Existing stats preserved (query shows `marketplace='vinted'` for old rows)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Migration is reversible (downgrade works)
- No breaking changes (existing code still works with new model)
- Stats can be filtered by marketplace
- Clear separation between Vinted, eBay, Etsy stats
</success_criteria>

<output>
After completion, create `.planning/phases/08-stats-system-refactoring/08-01-SUMMARY.md`:

# Phase 08-01: Stats System Refactoring Summary

**Refactored statistics tracking to be marketplace-agnostic with clear separation per marketplace.**

## Accomplishments

- Renamed table `vinted_job_stats` → `marketplace_job_stats`
- Added `marketplace` column (vinted, ebay, etsy) with check constraint
- Renamed model `VintedJobStats` → `MarketplaceJobStats`
- Updated `MarketplaceJobService` to pass/filter by marketplace
- Preserved all existing data (marked as marketplace='vinted')

## Files Created/Modified

**Migration**:
- `backend/migrations/versions/YYYYMMDD_HHMM_rename_vinted_job_stats_to_marketplace.py` (new)

**Models**:
- `backend/models/user/marketplace_job_stats.py` (renamed from vinted_job_stats.py)
- `backend/models/user/__init__.py` (updated imports)

**Services**:
- `backend/services/marketplace/marketplace_job_service.py` (updated to use MarketplaceJobStats + marketplace param)

## Decisions Made

**Keep VintedJobStatsService for now**: Decided not to refactor `VintedJobStatsService` in this phase (can be done in Phase 10 or later). Service still works because it queries the same table (now named differently).

**Hardcoded marketplace detection**: For now, services explicitly pass marketplace string ('vinted', 'ebay', 'etsy') based on context. Auto-detection from action_type_id deferred (complex FK relationships).

## Issues Encountered

[None / describe if any]

## Next Phase Readiness

**Remaining work**:
- `VintedJobStatsService` still references old model name (low priority - still works)
- Frontend queries need update to filter by marketplace (optional)
- API endpoints may need `?marketplace=vinted` query param (optional)

**Ready for**: Phase 9 (Schema Cleanup) or Phase 10 (Testing & Documentation)
</output>
