# Plan 02-01: Returns Backend Core

## Context

Phase 2 implements the core backend components for eBay returns management.

**Post-Order API Returns Endpoints** (researched):
- `GET /return/search` - Search returns with filters
- `GET /return/{returnId}` - Get return details
- `POST /return/{returnId}/decide` - Accept/decline return
- `POST /return/{returnId}/issue_refund` - Issue refund
- `POST /return/{returnId}/mark_as_received` - Mark item received
- `POST /return/{returnId}/send_message` - Send message to buyer

## Tasks

### Task 1: Create EbayReturnClient

**Goal**: Create a client for Post-Order API returns endpoints extending EbayPostOrderClient.

**Files to create**:
- `backend/services/ebay/ebay_return_client.py`

**Implementation**:

```python
class EbayReturnClient(EbayPostOrderClient):
    """Client for eBay Post-Order API returns endpoints."""

    def search_returns(
        self,
        order_id: Optional[str] = None,
        return_state: Optional[str] = None,
        creation_date_range_from: Optional[datetime] = None,
        creation_date_range_to: Optional[datetime] = None,
        limit: int = 50,
        offset: int = 0,
    ) -> Dict[str, Any]:
        """Search for returns with filters."""

    def get_return(self, return_id: str) -> Dict[str, Any]:
        """Get return details by ID."""

    def decide_return(
        self,
        return_id: str,
        decision: str,  # ACCEPT, DECLINE
        comments: Optional[str] = None,
        rma_number: Optional[str] = None,
    ) -> Dict[str, Any]:
        """Accept or decline a return request."""

    def issue_refund(
        self,
        return_id: str,
        refund_amount: Optional[float] = None,
        comments: Optional[str] = None,
    ) -> Dict[str, Any]:
        """Issue refund for a return."""

    def mark_as_received(
        self,
        return_id: str,
        comments: Optional[str] = None,
    ) -> Dict[str, Any]:
        """Mark return item as received."""

    def send_message(
        self,
        return_id: str,
        message: str,
    ) -> Dict[str, Any]:
        """Send message to buyer about return."""
```

**Acceptance Criteria**:
- [ ] All 6 methods implemented
- [ ] Uses `api_call_post_order()` from parent class
- [ ] Proper typing and docstrings

---

### Task 2: Create EbayReturn Model

**Goal**: Create SQLAlchemy model for storing returns in user schema.

**Files to create**:
- `backend/models/user/ebay_return.py`

**Model Schema**:

```python
class EbayReturn(Base):
    __tablename__ = "ebay_returns"
    __table_args__ = {"schema": "tenant"}

    # Primary Key
    id: Mapped[int] = BigInteger, primary_key, autoincrement

    # Return Identification
    return_id: Mapped[str] = Text, unique, index  # eBay return ID
    order_id: Mapped[str] = Text, FK â†’ ebay_orders.order_id, index

    # Status
    status: Mapped[str] = Text, index  # ReturnStatus enum value
    state: Mapped[str] = Text, index  # OPEN, CLOSED
    return_type: Mapped[str] = Text  # RETURN, REPLACEMENT, REFUND_ONLY

    # Reason
    reason: Mapped[str] = Text  # ReturnReason enum value
    reason_detail: Mapped[str] = Text, nullable

    # Refund
    refund_amount: Mapped[float] = Float, nullable
    refund_currency: Mapped[str] = Text, nullable
    refund_status: Mapped[str] = Text, nullable  # RefundStatus enum

    # Buyer Info
    buyer_username: Mapped[str] = Text, nullable
    buyer_comments: Mapped[str] = Text, nullable

    # Seller Info
    seller_comments: Mapped[str] = Text, nullable
    rma_number: Mapped[str] = Text, nullable

    # Return Shipping
    return_tracking_number: Mapped[str] = Text, nullable
    return_carrier: Mapped[str] = Text, nullable

    # Dates
    creation_date: Mapped[datetime] = DateTime, nullable
    deadline_date: Mapped[datetime] = DateTime, nullable
    closed_date: Mapped[datetime] = DateTime, nullable
    received_date: Mapped[datetime] = DateTime, nullable

    # eBay Raw Data (for debugging)
    raw_data: Mapped[dict] = JSONB, nullable

    # Metadata
    created_at: Mapped[datetime] = DateTime, server_default
    updated_at: Mapped[datetime] = DateTime, onupdate
```

**Acceptance Criteria**:
- [ ] Model follows existing EbayOrder pattern
- [ ] Uses tenant schema placeholder
- [ ] Proper indexes on frequently queried columns
- [ ] FK to ebay_orders for linkage

---

### Task 3: Create Alembic Migration

**Goal**: Create migration for ebay_returns table.

**Files to create**:
- `backend/migrations/versions/YYYYMMDD_add_ebay_returns.py`

**Migration Pattern**:
- Use multi-tenant fan-out to all user_* schemas
- Include template_tenant for new users

**Acceptance Criteria**:
- [ ] Creates ebay_returns table in all user schemas
- [ ] Includes proper FK constraint
- [ ] Includes downgrade function

---

## Execution Order

1. **Task 1**: Create `EbayReturnClient` (API layer)
2. **Task 2**: Create `EbayReturn` model (data layer)
3. **Task 3**: Create Alembic migration (schema)

## Dependencies

- `EbayPostOrderClient` from Phase 1
- `post_order_types.py` enums from Phase 1
- `EbayOrder` model for FK relationship

## Testing Strategy

- Unit tests for `EbayReturnClient` methods
- Test file: `backend/tests/unit/services/ebay/test_ebay_return_client.py`

## Estimated Effort

- Task 1: ~30 minutes
- Task 2: ~20 minutes
- Task 3: ~15 minutes
- **Total**: ~65 minutes

---

*Plan created: 2026-01-13*
