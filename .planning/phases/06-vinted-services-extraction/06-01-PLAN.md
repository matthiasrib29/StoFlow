# Plan 06-01: Vinted Services Extraction

## Objective

Extract business logic from Vinted job handlers (260+ lines inline) to dedicated services, following the same service delegation pattern successfully applied to eBay and Etsy handlers.

**Expected Outcome**: Create 3 new services (VintedPublicationService, VintedUpdateService, VintedDeletionService) that encapsulate marketplace-specific logic, preparing handlers for Phase 7 refactoring to BaseJobHandler pattern.

---

## Execution Context

**Working Directory**: `/home/maribeiro/StoFlow-task-orchestration-foundation/`

**Key Files**:
- Handlers to extract from: `backend/services/vinted/jobs/*_job_handler.py`
- Target services directory: `backend/services/vinted/`
- Existing services to reference: `backend/services/ebay/ebay_publication_service.py`, `backend/services/etsy/etsy_publication_service.py`

**Reference**: Phase 4 eBay services pattern, Phase 5 Etsy services pattern

---

## Context

### Current State

Vinted handlers contain **inline business logic** (260+ lines per handler):

**PublishJobHandler** (261 lines):
- Validation logic (product, attributes, images)
- Service orchestration (mapping, pricing, title, description)
- Image upload orchestration
- Payload construction
- Plugin communication (WebSocket)
- Post-processing (save VintedProduct, update status)

**UpdateJobHandler** (197 lines):
- Similar orchestration but for updates
- Price comparison logic
- Payload construction for updates
- Plugin communication

**DeleteJobHandler** (134 lines):
- Condition checking
- Archival logic (VintedDeletion)
- Plugin communication

**Problem**: This violates separation of concerns. Handlers should orchestrate, not implement business logic.

### Target State

**Pattern** (from eBay/Etsy):
```python
# Handler (thin orchestrator)
class VintedPublishJobHandler(BaseJobHandler):
    async def execute(self, job: MarketplaceJob):
        service = VintedPublicationService(self.db)
        result = await service.publish_product(job.product_id)
        return result

# Service (thick business logic)
class VintedPublicationService:
    async def publish_product(self, product_id: int) -> dict:
        # All validation, mapping, pricing, upload logic here
        ...
```

### Why Extract Services First (Before Handler Refactoring)

**Rationale**:
1. **Complexity**: Vinted handlers are 3x larger than eBay/Etsy handlers
2. **Risk Reduction**: Extract logic first, refactor handlers second (2 smaller PRs)
3. **Testing**: Can test services independently before handler migration
4. **WebSocket Complexity**: Vinted uses plugin communication (different from direct API)

**Phase 7** (next) will then refactor handlers to use BaseJobHandler + new services.

---

## Tasks

### Task 1: Create VintedPublicationService

**File**: `backend/services/vinted/vinted_publication_service.py`

**Extract from**: `backend/services/vinted/jobs/publish_job_handler.py` (lines 63-168)

**Service Structure**:
```python
class VintedPublicationService:
    """
    Service for publishing products to Vinted.

    Encapsulates the complete publication workflow:
    - Product validation
    - Attribute mapping
    - Price calculation
    - Title/description generation
    - Image upload
    - Listing creation
    - Post-processing
    """

    def __init__(self, db: Session):
        self.db = db
        self.mapping_service = VintedMappingService()
        self.pricing_service = VintedPricingService()
        self.validator = VintedProductValidator()
        self.title_service = VintedTitleService()
        self.description_service = VintedDescriptionService()

    async def publish_product(
        self,
        product_id: int,
        user_id: int,
        shop_id: int | None = None,
        job_id: int | None = None
    ) -> dict[str, Any]:
        """
        Publishes a product to Vinted.

        Args:
            product_id: Product ID to publish
            user_id: User ID for plugin communication
            shop_id: Optional shop ID
            job_id: Optional job ID for tracking

        Returns:
            dict: {
                "success": bool,
                "vinted_id": int | None,
                "url": str | None,
                "product_id": int,
                "error": str | None
            }
        """
        # Implementation extracted from PublishJobHandler.execute()
        ...
```

**Changes**:
1. Move all business logic from handler to service
2. Keep plugin communication in service (Vinted-specific)
3. Pass `user_id`, `shop_id`, `job_id` as parameters (service doesn't inherit from BaseJobHandler)
4. Service uses `logger` (not `self.log_*` methods)

**Verification**:
```bash
cd backend
source .venv/bin/activate
pytest tests/unit/services/vinted/test_vinted_publication_service.py -v
```

**Commit**: `refactor: extract VintedPublicationService from PublishJobHandler`

---

### Task 2: Create VintedUpdateService

**File**: `backend/services/vinted/vinted_update_service.py`

**Extract from**: `backend/services/vinted/jobs/update_job_handler.py` (lines 56-140)

**Service Structure**:
```python
class VintedUpdateService:
    """
    Service for updating products on Vinted.

    Handles:
    - Product and VintedProduct retrieval
    - Validation for updates
    - Attribute remapping
    - Price recalculation
    - Title/description regeneration
    - Payload construction
    - Update via plugin
    - Local VintedProduct update
    """

    def __init__(self, db: Session):
        self.db = db
        self.mapping_service = VintedMappingService()
        self.pricing_service = VintedPricingService()
        self.validator = VintedProductValidator()
        self.title_service = VintedTitleService()
        self.description_service = VintedDescriptionService()

    async def update_product(
        self,
        product_id: int,
        user_id: int,
        shop_id: int | None = None,
        job_id: int | None = None
    ) -> dict[str, Any]:
        """
        Updates a product on Vinted.

        Returns:
            dict: {
                "success": bool,
                "product_id": int,
                "old_price": float,
                "new_price": float,
                "error": str | None
            }
        """
        # Implementation extracted from UpdateJobHandler.execute()
        ...
```

**Verification**:
```bash
pytest tests/unit/services/vinted/test_vinted_update_service.py -v
```

**Commit**: `refactor: extract VintedUpdateService from UpdateJobHandler`

---

### Task 3: Create VintedDeletionService

**File**: `backend/services/vinted/vinted_deletion_service.py`

**Extract from**: `backend/services/vinted/jobs/delete_job_handler.py` (lines 37-104)

**Service Structure**:
```python
class VintedDeletionService:
    """
    Service for deleting products from Vinted.

    Handles:
    - VintedProduct retrieval
    - Deletion condition checking
    - Archival (VintedDeletion table)
    - Deletion via plugin
    - Local VintedProduct deletion
    """

    def __init__(self, db: Session):
        self.db = db

    async def delete_product(
        self,
        product_id: int,
        user_id: int,
        shop_id: int | None = None,
        job_id: int | None = None,
        check_conditions: bool = True
    ) -> dict[str, Any]:
        """
        Deletes a product from Vinted.

        Args:
            product_id: Product ID to delete
            user_id: User ID for plugin communication
            shop_id: Optional shop ID
            job_id: Optional job ID
            check_conditions: Whether to check deletion conditions

        Returns:
            dict: {
                "success": bool,
                "product_id": int,
                "vinted_id": int | None,
                "error": str | None
            }
        """
        # Implementation extracted from DeleteJobHandler.execute()
        ...
```

**Verification**:
```bash
pytest tests/unit/services/vinted/test_vinted_deletion_service.py -v
```

**Commit**: `refactor: extract VintedDeletionService from DeleteJobHandler`

---

### Task 4: Update PublishJobHandler to Delegate

**File**: `backend/services/vinted/jobs/publish_job_handler.py`

**Changes**:
1. Import VintedPublicationService
2. Replace inline logic with service delegation:
```python
async def execute(self, job: MarketplaceJob) -> dict[str, Any]:
    product_id = job.product_id
    if not product_id:
        return {"success": False, "error": "product_id required"}

    try:
        self.log_start(f"Publication produit #{product_id}")

        service = VintedPublicationService(self.db)
        result = await service.publish_product(
            product_id=product_id,
            user_id=self.user_id,
            shop_id=self.shop_id,
            job_id=self.job_id
        )

        if result.get("success"):
            self.log_success(f"Produit #{product_id} publié")
        else:
            self.log_error(f"Produit #{product_id}: {result.get('error')}")

        return result
    except Exception as e:
        self.log_error(f"Produit #{product_id}: {e}", exc_info=True)
        return {"success": False, "error": str(e)}
```

**Expected Reduction**: 261 lines → ~50 lines (80% reduction)

**Verification**:
```bash
pytest tests/unit/services/vinted/test_publish_job_handler.py -v
```

**Commit**: `refactor: migrate PublishJobHandler to use VintedPublicationService`

---

### Task 5: Update UpdateJobHandler to Delegate

**File**: `backend/services/vinted/jobs/update_job_handler.py`

**Changes**: Same pattern as Task 4
- Delegate to VintedUpdateService
- Keep only orchestration logic (logging, error handling)

**Expected Reduction**: 197 lines → ~50 lines (75% reduction)

**Verification**:
```bash
pytest tests/unit/services/vinted/test_update_job_handler.py -v
```

**Commit**: `refactor: migrate UpdateJobHandler to use VintedUpdateService`

---

### Task 6: Update DeleteJobHandler to Delegate

**File**: `backend/services/vinted/jobs/delete_job_handler.py`

**Changes**: Same pattern as Task 4
- Delegate to VintedDeletionService
- Extract `check_conditions` from job.result_data

**Expected Reduction**: 134 lines → ~40 lines (70% reduction)

**Verification**:
```bash
pytest tests/unit/services/vinted/test_delete_job_handler.py -v
```

**Commit**: `refactor: migrate DeleteJobHandler to use VintedDeletionService`

---

### Task 7: Run Full Test Suite

**Verification**: Ensure all Vinted services and handlers work after extraction.

```bash
cd backend
source .venv/bin/activate

# Service tests
pytest tests/unit/services/vinted/test_vinted_publication_service.py -v
pytest tests/unit/services/vinted/test_vinted_update_service.py -v
pytest tests/unit/services/vinted/test_vinted_deletion_service.py -v

# Handler tests (should still pass)
pytest tests/unit/services/vinted/test_publish_job_handler.py -v
pytest tests/unit/services/vinted/test_update_job_handler.py -v
pytest tests/unit/services/vinted/test_delete_job_handler.py -v

# Full suite
pytest tests/unit/services/vinted/ -v --tb=short
```

**Expected**: 95%+ test pass rate

**No Commit**: This is verification only

---

### Task 8: Create Phase Summary

**File**: `.planning/phases/06-vinted-services-extraction/06-01-SUMMARY.md`

**Content**:
- Services created (3/3)
- Handlers updated (3/3)
- Lines before/after metrics
- Code reduction percentage
- Test results
- Comparison with eBay/Etsy pattern

**Commit**: `docs: add Phase 6 summary (Vinted services extraction)`

---

## Verification

### Success Criteria

✅ 3 new services created (Publication, Update, Deletion)
✅ All services encapsulate complete business logic
✅ Handlers delegate to services (thin orchestrators)
✅ Total code reduction: ~350 lines (60%+)
✅ No changes to existing services (mapping, pricing, etc.)
✅ 95%+ tests passing
✅ Plugin communication still works (WebSocket)

### Test Commands

```bash
# Individual service tests
pytest tests/unit/services/vinted/test_vinted_publication_service.py -v
pytest tests/unit/services/vinted/test_vinted_update_service.py -v
pytest tests/unit/services/vinted/test_vinted_deletion_service.py -v

# Handler tests (verify delegation works)
pytest tests/unit/services/vinted/test_publish_job_handler.py -v
pytest tests/unit/services/vinted/test_update_job_handler.py -v
pytest tests/unit/services/vinted/test_delete_job_handler.py -v

# Full suite
pytest tests/unit/services/vinted/ -v --tb=short
```

### Manual Verification

1. Check each service file is ~150-200 lines
2. Check each handler file is ~40-50 lines
3. Verify handlers delegate to services
4. Confirm plugin communication logic is in services
5. Verify logging uses `logger` (not `self.log_*`)

---

## Output

### Git Commits (8 expected)

1. `refactor: extract VintedPublicationService from PublishJobHandler`
2. `refactor: extract VintedUpdateService from UpdateJobHandler`
3. `refactor: extract VintedDeletionService from DeleteJobHandler`
4. `refactor: migrate PublishJobHandler to use VintedPublicationService`
5. `refactor: migrate UpdateJobHandler to use VintedUpdateService`
6. `refactor: migrate DeleteJobHandler to use VintedDeletionService`
7. Optional: `test: add unit tests for new Vinted services`
8. `docs: add Phase 6 summary (Vinted services extraction)`

### Files Created

**New Services**:
- `backend/services/vinted/vinted_publication_service.py`
- `backend/services/vinted/vinted_update_service.py`
- `backend/services/vinted/vinted_deletion_service.py`

**New Tests** (if needed):
- `tests/unit/services/vinted/test_vinted_publication_service.py`
- `tests/unit/services/vinted/test_vinted_update_service.py`
- `tests/unit/services/vinted/test_vinted_deletion_service.py`

**Planning**:
- `.planning/phases/06-vinted-services-extraction/06-01-SUMMARY.md`

### Files Modified

- `backend/services/vinted/jobs/publish_job_handler.py` (261 → ~50 lines)
- `backend/services/vinted/jobs/update_job_handler.py` (197 → ~50 lines)
- `backend/services/vinted/jobs/delete_job_handler.py` (134 → ~40 lines)

### Metrics Target

| Metric | Target |
|--------|--------|
| Services created | 3/3 (100%) |
| Handlers updated | 3/3 (100%) |
| Lines before | ~592 lines |
| Lines after | ~140 lines (handlers) + ~450 lines (services) |
| Net reduction | ~200 lines saved |
| Tests passing | 95%+ |

---

## Known Risks

### Risk 1: Plugin Communication Complexity

**Likelihood**: Medium (WebSocket communication is handler-specific)
**Impact**: Medium (may need to refactor plugin helper)
**Mitigation**: Keep plugin communication in services, pass `user_id`/`job_id` as parameters

### Risk 2: Existing Tests Assume Inline Logic

**Likelihood**: High (tests may mock handler internals)
**Impact**: Medium (test adjustments needed)
**Mitigation**: Update tests to mock services instead of handler methods

### Risk 3: Service Signature Incompatibility

**Likelihood**: Low (services will match handler parameters)
**Impact**: Low (minor adjustments)
**Mitigation**: Services accept same parameters as handler.execute()

---

## Notes

- **Phase 7** (next) will refactor these handlers to use BaseJobHandler pattern
- Services are **NOT** thin wrappers - they contain full business logic
- Unlike eBay/Etsy, Vinted services handle plugin communication (WebSocket)
- Handler reduction target: ~140 lines total (down from ~592)
- Service size target: ~150-200 lines each (manageable complexity)

---

*Created: 2026-01-15*
*Worktree: StoFlow-task-orchestration-foundation*
*Branch: feature/task-orchestration-foundation*
*Phase: 06 - Vinted Services Extraction*
