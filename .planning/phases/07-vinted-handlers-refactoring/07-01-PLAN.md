# Plan 07-01: Vinted Handlers Refactoring (Core Handlers)

## Objective

Refactor the 3 core Vinted handlers (Publish, Update, Delete) to inherit from a new VintedJobHandler base class, reducing duplication and improving test maintainability.

**Expected Outcome**: Handlers become thin orchestrators (~30-40 lines) that delegate to services created in Phase 6, with updated tests that mock services instead of handler internals.

---

## Execution Context

**Working Directory**: `/home/maribeiro/StoFlow-task-orchestration-foundation/`

**Key Files**:
- Base to create: `backend/services/vinted/vinted_job_handler.py`
- Handlers to refactor: `backend/services/vinted/jobs/{publish,update,delete}_job_handler.py`
- Services (exist from Phase 6): `backend/services/vinted/vinted_{publication,update,deletion}_service.py`
- Tests: `tests/unit/services/vinted/`

**Reference**: Phase 4 eBay refactoring (DirectAPIJobHandler pattern), Phase 6 summary

---

## Context

### Current State

After Phase 6, handlers **delegate** to services but still contain boilerplate:

**Current Pattern** (~80-90 lines per handler):
```python
class PublishJobHandler(BaseJobHandler):
    ACTION_CODE = "publish"

    def create_tasks(self, job: MarketplaceJob) -> list[str]:
        return ["Validate", "Map", "Upload images", "Create listing", "Save"]

    async def execute(self, job: MarketplaceJob) -> dict[str, Any]:
        product_id = job.product_id
        if not product_id:
            return {"success": False, "error": "product_id required"}

        try:
            self.log_start(f"Publication produit #{product_id}")

            service = VintedPublicationService(self.db)
            result = await service.publish_product(
                product_id=product_id,
                user_id=self.user_id,
                shop_id=self.shop_id,
                job_id=self.job_id
            )

            if result.get("success"):
                self.log_success(f"Produit #{product_id} publié")
            else:
                self.log_error(f"Produit #{product_id}: {result.get('error')}")

            return result
        except Exception as e:
            self.log_error(f"Produit #{product_id}: {e}", exc_info=True)
            return {"success": False, "error": str(e)}
```

**Problem**: Duplication of validation, service instantiation, logging, error handling across handlers.

### Target State

**VintedJobHandler** base class + thin handlers (~30-40 lines):

```python
# backend/services/vinted/vinted_job_handler.py
class VintedJobHandler(BaseJobHandler):
    """
    Base for Vinted handlers that delegate to services.

    Factorizes:
    - Product validation
    - Service instantiation
    - Logging patterns
    - Exception handling
    """

    def get_service(self):
        """Return marketplace-specific service."""
        raise NotImplementedError

    def get_service_method_name(self) -> str:
        """Return method name to call on service."""
        raise NotImplementedError

    async def execute(self, job: MarketplaceJob) -> dict[str, Any]:
        """Execute with common pattern."""
        product_id = job.product_id
        if not product_id:
            return {"success": False, "error": "product_id required"}

        try:
            self.log_start(f"{self.ACTION_CODE} product #{product_id}")

            service = self.get_service()
            method = getattr(service, self.get_service_method_name())
            result = await method(
                product_id=product_id,
                user_id=self.user_id,
                shop_id=self.shop_id,
                job_id=self.job_id
            )

            if result.get("success"):
                self.log_success(f"Product #{product_id} {self.ACTION_CODE}ed")
            else:
                self.log_error(f"Product #{product_id}: {result.get('error')}")

            return result
        except Exception as e:
            self.log_error(f"Product #{product_id}: {e}", exc_info=True)
            return {"success": False, "error": str(e)}


# backend/services/vinted/jobs/publish_job_handler.py
class PublishJobHandler(VintedJobHandler):
    """Handler for publishing products to Vinted."""

    ACTION_CODE = "publish"

    def get_service(self) -> VintedPublicationService:
        return VintedPublicationService(self.db)

    def get_service_method_name(self) -> str:
        return "publish_product"

    def create_tasks(self, job: MarketplaceJob) -> list[str]:
        return ["Validate", "Map", "Upload images", "Create listing", "Save"]
```

### Why VintedJobHandler (not DirectAPIJobHandler)?

Vinted uses **WebSocket communication** (via plugin), not direct API calls like eBay/Etsy. The pattern is similar but implementation details differ:
- eBay/Etsy: HTTP requests with OAuth2
- Vinted: Plugin WebSocket + PluginWebSocketHelper

**Decision**: Create VintedJobHandler as sibling to DirectAPIJobHandler (not inheritance).

---

## Tasks

### Task 1: Create VintedJobHandler Base Class

**File**: `backend/services/vinted/vinted_job_handler.py`

**Changes**:
1. Create new file with VintedJobHandler class
2. Inherit from BaseJobHandler
3. Add abstract methods: `get_service()`, `get_service_method_name()`
4. Implement `execute()` with common pattern:
   - Product ID validation
   - Logging (log_start, log_success, log_error)
   - Service delegation via `get_service()` + `get_service_method_name()`
   - Exception handling
5. Keep `create_tasks()` abstract (defined in subclasses)

**Template**:
```python
"""
VintedJobHandler - Base class for Vinted-specific job handlers.

Provides common patterns for handlers that delegate to Vinted services:
- Product validation
- Service instantiation and method calling
- Logging patterns
- Exception handling

Unlike DirectAPIJobHandler (for eBay/Etsy), this supports Vinted's
WebSocket-based plugin communication.
"""

from typing import Any

from sqlalchemy.orm import Session

from models.user.marketplace_job import MarketplaceJob
from services.marketplace.base_job_handler import BaseJobHandler


class VintedJobHandler(BaseJobHandler):
    """
    Abstract base class for Vinted job handlers that delegate to services.

    Pattern:
    - Subclass defines get_service() and get_service_method_name()
    - Base class handles execution orchestration
    - Services contain all business logic
    """

    def get_service(self):
        """
        Return the service instance for this handler.

        Returns:
            Service instance (e.g., VintedPublicationService)
        """
        raise NotImplementedError("Subclass must implement get_service()")

    def get_service_method_name(self) -> str:
        """
        Return the method name to call on the service.

        Returns:
            Method name as string (e.g., "publish_product")
        """
        raise NotImplementedError("Subclass must implement get_service_method_name()")

    async def execute(self, job: MarketplaceJob) -> dict[str, Any]:
        """
        Execute job by delegating to service.

        Args:
            job: MarketplaceJob to execute

        Returns:
            dict: {
                "success": bool,
                "error": str | None,
                ... service-specific fields
            }
        """
        product_id = job.product_id
        if not product_id:
            return {"success": False, "error": "product_id required"}

        try:
            self.log_start(f"{self.ACTION_CODE} product #{product_id}")

            # Get service and method
            service = self.get_service()
            method_name = self.get_service_method_name()
            method = getattr(service, method_name)

            # Call service method
            result = await method(
                product_id=product_id,
                user_id=self.user_id,
                shop_id=self.shop_id,
                job_id=self.job_id
            )

            # Log result
            if result.get("success"):
                self.log_success(f"Product #{product_id} {self.ACTION_CODE}ed successfully")
            else:
                error = result.get("error", "Unknown error")
                self.log_error(f"Product #{product_id}: {error}")

            return result

        except Exception as e:
            self.log_error(f"Product #{product_id}: {e}", exc_info=True)
            return {"success": False, "error": str(e)}
```

**Verification**:
```bash
cd backend
source .venv/bin/activate
python -c "from services.vinted.vinted_job_handler import VintedJobHandler; print('Import OK')"
```

**Commit**: `refactor: create VintedJobHandler base class for service delegation`

---

### Task 2: Migrate PublishJobHandler to VintedJobHandler

**File**: `backend/services/vinted/jobs/publish_job_handler.py`

**Changes**:
1. Change base class: `BaseJobHandler` → `VintedJobHandler`
2. Add import: `from services.vinted.vinted_job_handler import VintedJobHandler`
3. Remove `execute()` method entirely
4. Add `get_service()` returning `VintedPublicationService(self.db)`
5. Add `get_service_method_name()` returning `"publish_product"`
6. Keep `create_tasks()` and `ACTION_CODE`

**Expected Reduction**: 89 lines → ~35 lines (60% reduction)

**Verification**:
```bash
pytest tests/unit/services/vinted/test_publish_job_handler.py -v --tb=short
```

**Commit**: `refactor: migrate PublishJobHandler to VintedJobHandler`

---

### Task 3: Migrate UpdateJobHandler to VintedJobHandler

**File**: `backend/services/vinted/jobs/update_job_handler.py`

**Changes**: Same pattern as Task 2
- Base class: `VintedJobHandler`
- Service: `VintedUpdateService(self.db)`
- Method: `"update_product"`

**Expected Reduction**: 79 lines → ~35 lines (56% reduction)

**Verification**:
```bash
pytest tests/unit/services/vinted/test_update_job_handler.py -v --tb=short
```

**Commit**: `refactor: migrate UpdateJobHandler to VintedJobHandler`

---

### Task 4: Migrate DeleteJobHandler to VintedJobHandler

**File**: `backend/services/vinted/jobs/delete_job_handler.py`

**Changes**: Same pattern as Task 2
- Base class: `VintedJobHandler`
- Service: `VintedDeletionService(self.db)`
- Method: `"delete_product"`

**Special Case**: DeleteJobHandler passes `check_conditions` parameter. Need to extract this from `job.result_data` before calling service:

```python
async def execute(self, job: MarketplaceJob) -> dict[str, Any]:
    """Override to handle check_conditions parameter."""
    product_id = job.product_id
    if not product_id:
        return {"success": False, "error": "product_id required"}

    # Extract check_conditions from job data
    check_conditions = job.result_data.get("check_conditions", True) if job.result_data else True

    try:
        self.log_start(f"Delete product #{product_id}")

        service = VintedDeletionService(self.db)
        result = await service.delete_product(
            product_id=product_id,
            user_id=self.user_id,
            shop_id=self.shop_id,
            job_id=self.job_id,
            check_conditions=check_conditions
        )

        if result.get("success"):
            self.log_success(f"Product #{product_id} deleted")
        else:
            self.log_error(f"Product #{product_id}: {result.get('error')}")

        return result
    except Exception as e:
        self.log_error(f"Product #{product_id}: {e}", exc_info=True)
        return {"success": False, "error": str(e)}
```

**Expected Reduction**: 81 lines → ~50 lines (38% reduction, less due to override)

**Verification**:
```bash
pytest tests/unit/services/vinted/test_delete_job_handler.py -v --tb=short
```

**Commit**: `refactor: migrate DeleteJobHandler to VintedJobHandler`

---

## Verification

### Success Criteria

✅ VintedJobHandler base class created
✅ All 3 handlers inherit from VintedJobHandler
✅ Each handler is ~30-50 lines (down from ~80-90)
✅ Total code reduction: ~150 lines (60%+)
✅ Handlers implement required abstract methods
✅ Tests pass (existing tests may need updates)

### Test Commands

```bash
# Individual handler tests
pytest tests/unit/services/vinted/test_publish_job_handler.py -v
pytest tests/unit/services/vinted/test_update_job_handler.py -v
pytest tests/unit/services/vinted/test_delete_job_handler.py -v

# All Vinted tests
pytest tests/unit/services/vinted/ -v --tb=short
```

### Manual Verification

1. Check VintedJobHandler has abstract methods
2. Verify each handler is ~30-50 lines
3. Confirm no `execute()` method in handlers (except DeleteJobHandler override)
4. Verify abstract methods implemented: `get_service()`, `get_service_method_name()`, `create_tasks()`

---

## Output

### Git Commits (4 expected)

1. `refactor: create VintedJobHandler base class for service delegation`
2. `refactor: migrate PublishJobHandler to VintedJobHandler`
3. `refactor: migrate UpdateJobHandler to VintedJobHandler`
4. `refactor: migrate DeleteJobHandler to VintedJobHandler`

### Files Created

- `backend/services/vinted/vinted_job_handler.py`

### Files Modified

- `backend/services/vinted/jobs/publish_job_handler.py` (89 → ~35 lines)
- `backend/services/vinted/jobs/update_job_handler.py` (79 → ~35 lines)
- `backend/services/vinted/jobs/delete_job_handler.py` (81 → ~50 lines)

### Metrics Target

| Metric | Target |
|--------|--------|
| Handlers migrated | 3/3 (100%) |
| Lines before | ~249 lines |
| Lines after | ~120 lines |
| Reduction | ~50% |
| Tests passing | 90%+ (some test updates expected) |

---

## Known Risks

### Risk 1: Tests Assume Inline Logic

**Likelihood**: High (87% pass rate in Phase 6 indicated test debt)
**Impact**: Medium (tests will fail, need updating)
**Mitigation**: Update tests to mock services instead of handler methods (deferred to Plan 07-02)

### Risk 2: DeleteJobHandler Special Case

**Likelihood**: Medium (check_conditions parameter differs from other handlers)
**Impact**: Low (requires execute() override but pattern still applies)
**Mitigation**: Document override pattern for future handlers with special parameters

---

## Notes

- This plan refactors **3 core handlers** (Publish, Update, Delete)
- **Remaining handlers** (Sync, LinkProduct, Message, Orders) will be refactored in Plan 07-02
- Test updates deferred to Plan 07-02 (focus on handler migration first)
- VintedJobHandler pattern similar to DirectAPIJobHandler but adapted for WebSocket

---

*Created: 2026-01-15*
*Worktree: StoFlow-task-orchestration-foundation*
*Branch: feature/task-orchestration-foundation*
*Phase: 07 - Vinted Handlers Refactoring*
