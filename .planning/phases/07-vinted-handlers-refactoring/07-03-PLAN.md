---
phase: 07-vinted-handlers-refactoring
plan: 03
type: execute
---

<objective>
Complete Phase 7 by migrating the 4 remaining Vinted handlers (Sync, LinkProduct, Message, Orders) to follow the same pattern: thin handlers that delegate to services.

Purpose: Finish Vinted handlers refactoring with consistent delegation pattern across ALL handlers.
Output: 4 new services + 4 refactored thin handlers (~40-60 lines each) + updated tests.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-vinted-handlers-refactoring/07-01-SUMMARY.md
@.planning/phases/07-vinted-handlers-refactoring/07-02-SUMMARY.md

## Current State (After 07-01 and 07-02)

**Migrated (3 handlers)**: Publish, Update, Delete
- Pattern: Inherit from `VintedJobHandler` base
- Thin handlers (~30-40 lines)
- Delegate to services (VintedPublicationService, etc.)
- Tests refactored (14 tests, 100% pass rate)

**Remaining (4 handlers)**:
1. **SyncJobHandler** (101 lines) - Syncs all products from Vinted API
2. **LinkProductJobHandler** (116 lines) - Links VintedProduct → Product
3. **MessageJobHandler** (157 lines) - Handles Vinted messages
4. **OrdersJobHandler** (149 lines) - Syncs orders from Vinted

**Total**: 523 lines of handler code to refactor

## Pattern Differences (Why Not Migrated Yet)

According to 07-02 summary, these handlers were left as-is because:
- No standard `product_id` parameter
- Different workflows (sync all, linking, messaging, orders)
- Don't fit VintedJobHandler pattern (which expects product_id)

**YOLO Decision**: Extract services anyway and make handlers thin, even if they don't inherit from VintedJobHandler.

## Target Pattern

For each handler:
1. **Create service** (e.g., `VintedSyncService`) with business logic
2. **Refactor handler** to delegate to service (~40-60 lines)
3. **Implement `create_tasks()`** (task orchestration)
4. **Update/create minimal tests** (mock service, test public API)

</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract services for 4 remaining handlers</name>
  <files>
backend/services/vinted/vinted_sync_service.py,
backend/services/vinted/vinted_link_product_service.py,
backend/services/vinted/vinted_message_service.py,
backend/services/vinted/vinted_orders_service.py
  </files>
  <action>
Create 4 new service classes following the pattern from Phase 6:

**1. VintedSyncService** (extract from SyncJobHandler):
- Method: `sync_products(shop_id: int, user_id: int) -> dict`
- Logic: Call VintedApiSyncService to sync all products
- Return: `{"success": bool, "products_synced": int, "errors": list}`

**2. VintedLinkProductService** (extract from LinkProductJobHandler):
- Method: `link_product(vinted_product_id: int, product_id: int, user_id: int) -> dict`
- Logic: Link VintedProduct to Product in DB
- Return: `{"success": bool, "linked": bool}`

**3. VintedMessageService** (extract from MessageJobHandler):
- Method: `handle_message(message_id: int, user_id: int, shop_id: int) -> dict`
- Logic: Process Vinted message (read/reply)
- Return: `{"success": bool, "message_handled": bool}`

**4. VintedOrdersService** (extract from OrdersJobHandler):
- Method: `sync_orders(shop_id: int, user_id: int) -> dict`
- Logic: Sync orders from Vinted API
- Return: `{"success": bool, "orders_synced": int}`

Each service should:
- Take DB session in `__init__` (like VintedPublicationService)
- Have clear method signature with typed params
- Extract ALL business logic from handler
- Handle errors internally and return structured dict

**Avoid**: Creating overly complex services. Keep them simple wrappers around existing logic.
  </action>
  <verify>
```bash
cd backend
python -c "from services.vinted.vinted_sync_service import VintedSyncService; print('VintedSyncService OK')"
python -c "from services.vinted.vinted_link_product_service import VintedLinkProductService; print('VintedLinkProductService OK')"
python -c "from services.vinted.vinted_message_service import VintedMessageService; print('VintedMessageService OK')"
python -c "from services.vinted.vinted_orders_service import VintedOrdersService; print('VintedOrdersService OK')"
```
  </verify>
  <done>
- 4 new service files created
- All services have clear method signatures
- Business logic extracted from handlers
- No import errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor 4 handlers to delegate to services</name>
  <files>
backend/services/vinted/jobs/sync_job_handler.py,
backend/services/vinted/jobs/link_product_job_handler.py,
backend/services/vinted/jobs/message_job_handler.py,
backend/services/vinted/jobs/orders_job_handler.py
  </files>
  <action>
Refactor each handler to become thin orchestrator (~40-60 lines):

**Pattern for each handler**:

```python
from services.vinted.vinted_XXX_service import VintedXXXService

class XXXJobHandler(BaseJobHandler):
    ACTION_CODE = "xxx"

    def create_tasks(self, job: MarketplaceJob) -> list[str]:
        """Define task steps."""
        return ["Step 1", "Step 2", "Step 3"]

    def get_service(self) -> VintedXXXService:
        """Get service instance."""
        return VintedXXXService(self.db)

    async def execute(self, job: MarketplaceJob) -> dict[str, Any]:
        """Execute job by delegating to service."""
        try:
            self.log_start(f"Starting {self.ACTION_CODE}")

            service = self.get_service()
            result = await service.xxx_method(
                param1=...,
                param2=...,
                user_id=self.user_id,
                shop_id=self.shop_id
            )

            self.log_end(f"Completed {self.ACTION_CODE}")
            return result
        except Exception as e:
            self.log_error(f"Failed: {e}")
            return {"success": False, "error": str(e)}
```

**For each handler**:
1. Import service
2. Implement `get_service()` method
3. Implement `create_tasks()` with 3-5 task steps
4. Refactor `execute()` to delegate to service
5. Remove all business logic (move to service if not done in Task 1)
6. Keep only orchestration code (logging, error handling, delegation)

**Target lines**:
- SyncJobHandler: 101 → ~50 lines
- LinkProductJobHandler: 116 → ~50 lines
- MessageJobHandler: 157 → ~60 lines
- OrdersJobHandler: 149 → ~60 lines

**Avoid**: Keeping business logic in handlers. ALL logic should be in services.
  </action>
  <verify>
```bash
cd backend
# Check handler sizes
wc -l services/vinted/jobs/sync_job_handler.py
wc -l services/vinted/jobs/link_product_job_handler.py
wc -l services/vinted/jobs/message_job_handler.py
wc -l services/vinted/jobs/orders_job_handler.py

# Check no inline business logic (grep for complex logic)
grep -E "(if.*and.*or|for.*in.*if|while|try.*except.*except)" services/vinted/jobs/sync_job_handler.py | wc -l
# Should be minimal (only orchestration logic)
```
  </verify>
  <done>
- All 4 handlers refactored to ~40-60 lines
- All handlers delegate to services
- All handlers implement `create_tasks()` and `get_service()`
- No business logic in handlers (only orchestration)
- Handlers follow same pattern as Publish/Update/Delete
  </done>
</task>

<task type="auto">
  <name>Task 3: Create minimal tests for refactored handlers</name>
  <files>backend/tests/unit/services/vinted/test_vinted_refactored_handlers.py (append)</files>
  <action>
Add test classes for the 4 remaining handlers to the existing `test_vinted_refactored_handlers.py` file (created in 07-02).

**For each handler, add 3-4 tests**:

```python
class TestSyncJobHandler:
    """Tests for SyncJobHandler."""

    @pytest.fixture
    def handler(self, db_session):
        return SyncJobHandler(db_session, shop_id=1, job_id=1)

    def test_get_service(self, handler):
        """Test get_service returns correct service type."""
        service = handler.get_service()
        assert service.__class__.__name__ == "VintedSyncService"

    def test_create_tasks(self, handler, job):
        """Test create_tasks returns task list."""
        tasks = handler.create_tasks(job)
        assert isinstance(tasks, list)
        assert len(tasks) > 0

    @pytest.mark.asyncio
    async def test_execute_success(self, handler, job):
        """Test execute delegates to service successfully."""
        mock_service = Mock()
        mock_service.sync_products = AsyncMock(return_value={
            "success": True,
            "products_synced": 10
        })

        with patch.object(handler, 'get_service', return_value=mock_service):
            result = await handler.execute(job)

        assert result["success"] is True
        assert result["products_synced"] == 10

    @pytest.mark.asyncio
    async def test_execute_failure(self, handler, job):
        """Test execute handles service failure."""
        mock_service = Mock()
        mock_service.sync_products = AsyncMock(return_value={
            "success": False,
            "error": "API error"
        })

        with patch.object(handler, 'get_service', return_value=mock_service):
            result = await handler.execute(job)

        assert result["success"] is False
```

Repeat for: LinkProductJobHandler, MessageJobHandler, OrdersJobHandler

**Total new tests**: ~12-16 tests (3-4 per handler)

**Focus**: Test only public API (execute, get_service, create_tasks). Mock services. Don't test private methods.

**Avoid**: Testing service internals (services have their own tests if needed).
  </action>
  <verify>
```bash
cd backend
# Run new tests
pytest tests/unit/services/vinted/test_vinted_refactored_handlers.py::TestSyncJobHandler -v
pytest tests/unit/services/vinted/test_vinted_refactored_handlers.py::TestLinkProductJobHandler -v
pytest tests/unit/services/vinted/test_vinted_refactored_handlers.py::TestMessageJobHandler -v
pytest tests/unit/services/vinted/test_vinted_refactored_handlers.py::TestOrdersJobHandler -v

# Check all Vinted tests pass
pytest tests/unit/services/vinted/ -v
```
  </verify>
  <done>
- 12-16 new tests added for 4 handlers
- All tests follow same pattern (test public API, mock services)
- All tests pass (100% pass rate maintained)
- Test file size reasonable (~350-400 lines total)
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All 4 new services created and importable
- [ ] All 4 handlers refactored to ~40-60 lines
- [ ] All handlers implement `create_tasks()` and `get_service()`
- [ ] All handlers delegate to services
- [ ] 12-16 new tests added
- [ ] All Vinted tests pass (`pytest tests/unit/services/vinted/ -v`)
- [ ] No business logic in handlers (only orchestration)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Phase 7 100% complete (all 7 Vinted handlers migrated)
- Consistent pattern across all handlers (thin orchestrators + service delegation)
- Test coverage maintained (100% pass rate)
- Total handler lines reduced from ~1200 to ~400 lines (67% reduction)
</success_criteria>

<output>
After completion, create `.planning/phases/07-vinted-handlers-refactoring/07-03-SUMMARY.md`:

# Phase 07-03: Vinted Handlers Complete Migration Summary

**Completed Vinted handlers refactoring: migrated remaining 4 handlers (Sync, LinkProduct, Message, Orders).**

## Accomplishments

- Created 4 new services: VintedSyncService, VintedLinkProductService, VintedMessageService, VintedOrdersService
- Refactored 4 handlers to thin orchestrators (~40-60 lines each)
- Added 12-16 new tests (test public API, mock services)
- All 7 Vinted handlers now follow consistent pattern

## Code Metrics

| Metric | Before 07-03 | After 07-03 | Change |
|--------|--------------|-------------|--------|
| **Handlers remaining** | 4 (523 lines) | 0 (refactored) | -4 handlers |
| **Services created** | 3 (Phase 6) | 7 total | +4 services |
| **Total handler lines** | ~1200 | ~400 | **-67%** |
| **Tests** | 14 | ~26-30 | +12-16 tests |
| **Pass rate** | 100% | 100% | ✅ Maintained |

## Files Created/Modified

**Services**:
- `backend/services/vinted/vinted_sync_service.py` (new)
- `backend/services/vinted/vinted_link_product_service.py` (new)
- `backend/services/vinted/vinted_message_service.py` (new)
- `backend/services/vinted/vinted_orders_service.py` (new)

**Handlers**:
- `backend/services/vinted/jobs/sync_job_handler.py` (refactored)
- `backend/services/vinted/jobs/link_product_job_handler.py` (refactored)
- `backend/services/vinted/jobs/message_job_handler.py` (refactored)
- `backend/services/vinted/jobs/orders_job_handler.py` (refactored)

**Tests**:
- `backend/tests/unit/services/vinted/test_vinted_refactored_handlers.py` (extended)

## Decisions Made

**Extracted services even for non-standard workflows**: Unlike 07-02 decision to leave handlers as-is, decided to extract services anyway for consistency.

## Phase 7 Status

✅ **COMPLETE** - All 7 Vinted handlers migrated to thin orchestrator pattern with service delegation.

## Next Phase

Ready for Phase 8: Stats System Refactoring
</output>
