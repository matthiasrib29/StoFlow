---
phase: 07-testing-polish
plan: 02
type: execute
---

<objective>
Complete final validation through manual E2E testing, update documentation, and prepare for code review.

Purpose: Ensure production readiness through real-world testing, comprehensive documentation, and systematic review preparation.

Output: Validated pricing feature with updated PROJECT.md and code review checklist completed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-main-pricing-algorithm/05-01-SUMMARY.md
@.planning/phases/05-main-pricing-algorithm/05-02-SUMMARY.md
@.planning/phases/05-main-pricing-algorithm/05-03-SUMMARY.md
@.planning/phases/06-frontend-ui/06-01-SUMMARY.md
@.planning/phases/06-frontend-ui/06-02-SUMMARY.md
@.planning/phases/07-testing-polish/07-01-SUMMARY.md

**Phase dependencies:**
- All 6 prior phases complete (database, logic, generation, calculators, API, UI)
- Plan 07-01: Frontend tests implemented and passing
- Backend tests: 2500+ lines (unit + integration from Phases 4-5)
- Frontend tests: usePricingCalculation fully tested

**Complete pricing feature:**
1. User opens product detail page
2. Clicks "Calculate Price" button
3. Backend: determines group → fetches/generates Brand×Group → fetches/generates Model → calculates 6 adjustments → returns 3 prices
4. Frontend: displays PricingDisplay component with breakdown
5. User can expand to see adjustment details and formula

**Tech stack:**
- Backend: FastAPI, PostgreSQL, SQLAlchemy, Google Gemini
- Frontend: Nuxt.js 3, Vue 3 Composition API, Tailwind CSS
- Testing: pytest (backend), Vitest + @nuxt/test-utils (frontend)

**Key achievements to document:**
- 69 product groups with material-based determination
- LLM-generated Brand×Group base prices (€20-500 range)
- LLM-generated Model coefficients (0.6-2.0 range)
- 6 adjustment calculators (condition, origin, decade, trend, feature, model)
- 3 price levels: quick (×0.75), standard (×1.0), premium (×1.30)
- Full error handling (400/500/504) with performance logging
- Transparent UI with expandable breakdown
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manual E2E test script with real brand scenarios</name>
  <files>.planning/phases/07-testing-polish/E2E-TEST-SCENARIOS.md</files>
  <action>
Create comprehensive E2E testing documentation with real-world scenarios:

**Structure:**
```markdown
# E2E Test Scenarios - Pricing Algorithm

**Purpose**: Manual validation with realistic brand and product data to verify end-to-end functionality.

**Prerequisites**:
- Backend running: `cd backend && uvicorn main:app --reload`
- Frontend running: `cd frontend && npm run dev`
- User authenticated in frontend
- At least one product created in dashboard

---

## Test Scenario 1: Luxury Fashion - Louis Vuitton Handbag

**Product Data**:
- Brand: Louis Vuitton
- Category: Bag
- Materials: [Leather]
- Model: Speedy 30
- Condition Score: 4 (Very Good)
- Supplements: [Original Box, Dust Bag, Authentication Card]
- Origin: France
- Decade: 2010s
- Trends: [Vintage Revival, Minimalism]
- Features: [Monogram Canvas, Golden Hardware]

**Expected Behavior**:
1. Click "Calculate Price" on product detail page
2. Loading spinner appears (1-5 seconds)
3. Backend determines group: "bag_leather"
4. Backend fetches/generates Louis Vuitton × bag_leather base price (expect ~€200-400)
5. Backend fetches/generates Speedy 30 model coefficient (expect ~1.2-1.5)
6. Backend calculates adjustments:
   - Condition: +0.14 (score 4 + 3 supplements)
   - Origin: +0.10 (France expected for luxury bags)
   - Decade: 0.00 (2010s typical for fashion)
   - Trend: +0.05 (Vintage Revival matches expected)
   - Feature: +0.10 (Monogram + Hardware expected features)
   - Total: ~+0.39
7. PricingDisplay shows 3 prices (proportions: 0.75 / 1.0 / 1.3)
8. Breakdown section toggles correctly
9. All 6 adjustments visible with correct signs and colors
10. Formula shown: Base × Model × (1 + Total)

**Validation Checklist**:
- [ ] Calculate button works
- [ ] Loading state appears
- [ ] Prices returned within 10 seconds
- [ ] 3 price cards displayed (Quick/Standard/Premium)
- [ ] Standard price marked "Recommended"
- [ ] Breakdown section expandable
- [ ] All 6 adjustments shown
- [ ] Colors correct (green for positive, red for negative)
- [ ] Formula visible and accurate
- [ ] No console errors

---

## Test Scenario 2: Streetwear - Nike Air Jordan 1

**Product Data**:
- Brand: Nike
- Category: Sneakers
- Materials: [Leather, Rubber]
- Model: Air Jordan 1 Retro High OG
- Condition Score: 5 (New/Mint)
- Supplements: [Original Box, Extra Laces]
- Origin: China
- Decade: 2020s
- Trends: [Streetwear, Sneaker Culture]
- Features: [OG Colorway, High Top]

**Expected Behavior**:
1. Group: "sneakers_leather"
2. Base price: €80-150 (mid-range sneakers)
3. Model coefficient: 1.8-2.2 (Air Jordan 1 is iconic)
4. Adjustments:
   - Condition: +0.16 (score 5 + 2 supplements)
   - Origin: 0.00 (China typical for sneakers)
   - Decade: -0.05 (2020s recent, less vintage value)
   - Trend: +0.10 (Streetwear + Sneaker Culture both expected)
   - Feature: +0.15 (OG Colorway highly valued)
   - Total: ~+0.36
5. Prices displayed correctly

**Validation**: Same checklist as Scenario 1

---

## Test Scenario 3: Vintage Furniture - Mid-Century Danish Chair

**Product Data**:
- Brand: Unknown/Generic
- Category: Furniture
- Materials: [Wood, Fabric]
- Model: (leave empty)
- Condition Score: 3 (Good)
- Supplements: []
- Origin: Denmark
- Decade: 1960s
- Trends: [Mid-Century Modern]
- Features: [Teak Wood, Original Upholstery]

**Expected Behavior**:
1. Group: "furniture_wood"
2. Base price: €50-100 (generic furniture)
3. Model coefficient: 1.0 (no model specified)
4. Adjustments:
   - Condition: +0.05 (score 3, no supplements)
   - Origin: +0.15 (Denmark premium for mid-century furniture)
   - Decade: +0.20 (1960s highly valued for mid-century)
   - Trend: +0.15 (Mid-Century Modern is expected trend)
   - Feature: +0.20 (Teak + Original Upholstery premium)
   - Total: ~+0.75
5. High premium due to vintage value

**Validation**: Same checklist as Scenario 1

---

## Test Scenario 4: Error Handling - Invalid Product

**Product Data**:
- Brand: (empty)
- Category: (empty)
- Materials: []

**Expected Behavior**:
1. "Calculate Price" button should be disabled (validation)
2. OR if clicked, backend returns 400
3. Error banner displays: "Invalid product data. Please check all fields."
4. No pricing displayed
5. User can correct and retry

**Validation**:
- [ ] Validation prevents calculation OR
- [ ] 400 error handled gracefully
- [ ] Error message user-friendly
- [ ] No crash or console errors

---

## Test Scenario 5: Timeout Simulation (if possible)

**Setup**: Temporarily modify backend to sleep 35+ seconds in calculate endpoint

**Expected Behavior**:
1. Loading spinner for 30+ seconds
2. Backend returns 504 (timeout)
3. Error banner: "Pricing calculation timed out. Please try again."
4. User can retry

**Validation**:
- [ ] Timeout handled without crash
- [ ] User-friendly error message
- [ ] Can retry successfully after timeout

---

## Summary Checklist

After all scenarios:
- [ ] 3+ successful price calculations with different brands/categories
- [ ] All price levels (Quick/Standard/Premium) reasonable
- [ ] Breakdown adjustments make logical sense
- [ ] Error handling works (validation, timeout if tested)
- [ ] No console errors in any scenario
- [ ] UI responsive on mobile and desktop
- [ ] Loading states clear and non-blocking
- [ ] Can calculate multiple times without page refresh
```

**Why this structure:**
- Real-world brand scenarios (luxury, streetwear, vintage)
- Covers different product types and complexity
- Tests both happy path and error cases
- Explicit validation checklists
- Documents expected ranges for manual verification
  </action>
  <verify>
File exists at `.planning/phases/07-testing-polish/E2E-TEST-SCENARIOS.md` with 5 comprehensive test scenarios
  </verify>
  <done>
- E2E-TEST-SCENARIOS.md created with 5 scenarios
- Scenarios cover: luxury fashion, streetwear, vintage, error handling, timeout
- Each scenario has product data, expected behavior, validation checklist
- Realistic brand examples (Louis Vuitton, Nike, etc.)
- Error cases documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PROJECT.md with implementation summary</name>
  <files>.planning/PROJECT.md</files>
  <action>
Add comprehensive implementation summary to PROJECT.md (append to end or create new "Implementation" section):

**Content to add:**
```markdown
---

## Implementation Summary

**Feature**: Intelligent Pricing Algorithm
**Status**: Complete ✅
**Completed**: 2026-01-12

### Overview

Implemented a comprehensive pricing algorithm that generates intelligent price suggestions for secondhand products using LLM-powered data generation and a transparent adjustment-based calculation formula.

### Architecture

**Backend (FastAPI + PostgreSQL + Google Gemini)**:
- **Database**: Brand×Group base prices + Model coefficients (auto-generated via LLM)
- **Group Determination**: 69 product groups based on category + materials
- **LLM Generation Service**: Gemini-powered generation with validation and fallbacks
- **6 Adjustment Calculators**: Condition, Origin, Decade, Trend, Feature, Model
- **Pricing Service**: Orchestrates fetch-or-generate → calculate → return 3 price levels
- **REST API**: POST /api/pricing/calculate with JWT auth

**Frontend (Nuxt.js 3 + Vue 3 + Tailwind CSS)**:
- **Composable**: usePricingCalculation for API integration and state management
- **Component**: PricingDisplay with 3 color-coded price cards + expandable breakdown
- **Integration**: Product detail page with "Calculate Price" button

### Pricing Formula

```
STANDARD_PRICE = BASE_PRICE × MODEL_COEFF × (1 + TOTAL_ADJUSTMENTS)

Where:
- BASE_PRICE: LLM-generated for Brand×Group (€20-500 range)
- MODEL_COEFF: LLM-generated for specific models (0.6-2.0 range), default 1.0
- TOTAL_ADJUSTMENTS: Sum of 6 adjustment values (-1.0 to +1.0 each)

Price Levels:
- Quick Sale: STANDARD × 0.75
- Standard: STANDARD × 1.0 (recommended)
- Premium: STANDARD × 1.30
```

### Adjustment Calculators

1. **Condition** (-0.50 to +0.20): Based on condition score (0-5) + supplements
2. **Origin** (-0.30 to +0.30): Tier-based comparison (actual vs expected)
3. **Decade** (-0.10 to +0.30): Bonus for unexpected vintage decades
4. **Trend** (-0.05 to +0.25): Best unexpected trend bonus
5. **Feature** (-0.10 to +0.30): Sum of unexpected feature bonuses
6. **Model**: Coefficient multiplier (not additive)

### Product Groups (69 total)

**Categories with material variations**:
- Bags: leather, textile, exotic
- Clothing: coats (leather/textile/wool), jackets (leather/denim/textile), pants (denim/textile), etc.
- Shoes: sneakers, boots, heels (leather/textile variations)
- Accessories: watches, jewelry, scarves, etc.
- Home: furniture, decoration (wood/metal/glass variations)

### Error Handling

- **400**: Validation errors (missing fields, invalid ranges)
- **500**: LLM generation failures (with database rollback)
- **504**: Timeout errors (>30s processing)
- **Logging**: Structured logging with elapsed_time_ms, user_id, brand context

### Testing

**Backend**:
- Unit tests: 94 tests for adjustment calculators
- Unit tests: 20 tests for pricing service orchestration
- Integration tests: 19 tests for API endpoint
- Total: 2500+ lines of test code

**Frontend**:
- Unit tests: 9+ tests for usePricingCalculation composable
- Configured: Vitest + @nuxt/test-utils
- Coverage: State management, API integration, error handling

**E2E**:
- Manual test scenarios documented (luxury, streetwear, vintage, errors)
- Real-world brand validation

### Key Decisions

1. **LLM Provider**: Google Gemini (already integrated, generous free tier)
2. **Fetch-or-Generate**: Automatic LLM fallback if data missing (no manual seeding)
3. **Price Transparency**: Expandable breakdown showing all adjustments + formula
4. **Color Scheme**: Blue (quick), Green (standard/recommended), Purple (premium)
5. **Error Strategy**: User-friendly messages, no stack traces, performance logging
6. **Test Strategy**: Comprehensive backend coverage, frontend composable testing

### Files

**Backend**:
- `backend/repositories/brand_group_repository.py`
- `backend/repositories/model_repository.py`
- `backend/services/pricing/group_determination.py`
- `backend/services/pricing/adjustment_calculators.py`
- `backend/services/pricing_generation_service.py`
- `backend/services/pricing_service.py`
- `backend/api/pricing.py`
- `backend/schemas/pricing.py`
- `backend/models/public/brand_group.py`
- `backend/models/public/model.py`

**Frontend**:
- `frontend/composables/usePricingCalculation.ts`
- `frontend/components/products/PricingDisplay.vue`
- `frontend/pages/dashboard/products/[id]/index.vue` (integration)

**Database**:
- Migration: `2f3a9708b420_add_brand_groups_table.py`
- Migration: `68a6d6ef6f65_add_models_table.py`

### Performance

- **Average Response Time**: 2-5 seconds (with LLM generation)
- **Cached Response Time**: <500ms (data already exists)
- **Timeout Threshold**: 30 seconds
- **Database**: Indexed on brand+group, brand+group+model for fast lookups

### Future Enhancements

Logged in `.planning/ISSUES.md`:
- Performance optimization: connection pooling, caching strategies
- Enhanced model generation: more context, fine-tuning
- Additional adjustment factors: seasonality, market trends
- Bulk pricing calculations
- Price history tracking
```

**Why this content:**
- Comprehensive technical summary for future reference
- Documents all architecture decisions
- Provides quick reference for formula and adjustments
- Lists all key files for maintenance
- Performance metrics documented
- Foundation for code review and handoff
  </action>
  <verify>
`.planning/PROJECT.md` contains new "Implementation Summary" section with complete technical documentation
  </verify>
  <done>
- PROJECT.md updated with implementation summary
- Covers: architecture, formula, adjustments, groups, error handling, testing, decisions, files, performance
- Documentation comprehensive and accurate
- Ready for code review and future maintenance
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete pricing algorithm feature with comprehensive documentation and test scenarios.

**Final deliverables**:
1. Backend: Full pricing service with 6 calculators, LLM generation, API endpoint
2. Frontend: usePricingCalculation composable + PricingDisplay component
3. Tests: 2500+ lines backend tests + frontend composable tests
4. Documentation: PROJECT.md implementation summary + E2E test scenarios
  </what-built>
  <how-to-verify>
**Code Review Readiness Checklist**:

1. **Run E2E Test Scenarios** (from Task 1):
   - Start backend: `cd backend && uvicorn main:app --reload`
   - Start frontend: `cd frontend && npm run dev`
   - Follow at least 3 scenarios from E2E-TEST-SCENARIOS.md
   - Verify: All calculations work, UI displays correctly, no errors

2. **Run Test Suites**:
   - Backend: `cd backend && pytest -v`
   - Frontend: `cd frontend && npm test`
   - Verify: All tests passing, no failures

3. **Code Quality Checks**:
   - No console.log() left in production code
   - No TODO/FIXME comments (except intentional future enhancements)
   - No obvious security issues (validated inputs, no secrets in code)
   - Error messages user-friendly (no stack traces exposed)
   - Logging appropriate (INFO for operations, DEBUG for details)

4. **Documentation Review**:
   - Read PROJECT.md implementation summary
   - Verify: Accurate, complete, useful for future developers
   - Check: Formula documented, architecture clear, files listed

5. **Git History**:
   - Review commit messages: Clear, conventional format, atomic
   - Verify: Each task has own commit, metadata commits separate
   - Check: No accidental commits of secrets or temp files

6. **Performance Validation** (spot check):
   - Calculate price for 1-2 products
   - Verify: Response time <10s, UI responsive, no lag

7. **Edge Case Testing** (spot check):
   - Test with empty optional fields (model, trends, features)
   - Test with extreme values (condition 0 vs 5, many supplements)
   - Verify: No crashes, reasonable price outputs

**Expected results**: All checks pass, feature production-ready.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] E2E test scenarios documented (5+ scenarios)
- [ ] PROJECT.md updated with implementation summary
- [ ] Manual testing completed successfully (3+ scenarios)
- [ ] All backend tests passing (pytest)
- [ ] All frontend tests passing (npm test)
- [ ] Code review checklist verified
- [ ] No critical issues found
</verification>

<success_criteria>

- All tasks completed
- E2E test scenarios documented and validated
- PROJECT.md comprehensively updated
- Code review checklist passed
- Phase 7 COMPLETE (all 7 phases finished)
- Pricing algorithm feature production-ready
</success_criteria>

<output>
After completion, create `.planning/phases/07-testing-polish/07-02-SUMMARY.md`:

# Phase 7 Plan 2: Documentation & Validation Summary

**[Substantive one-liner describing testing and documentation completion]**

## Accomplishments

- E2E test scenarios created with 5 real-world brand examples
- PROJECT.md updated with comprehensive implementation summary
- Manual testing completed (luxury, streetwear, vintage scenarios)
- Code review checklist validated
- All quality checks passed
- Feature certified production-ready

## Files Created/Modified

- `.planning/phases/07-testing-polish/E2E-TEST-SCENARIOS.md` - Manual test scenarios
- `.planning/PROJECT.md` - Implementation summary added

## Decisions Made

[Testing approach, documentation scope, or "None"]

## Issues Encountered

[Any bugs found and fixed during testing, or "None"]

## Next Step

**PHASE 7 COMPLETE ✅**
**ALL 7 PHASES COMPLETE ✅**

Pricing algorithm feature is production-ready:
- Backend: Fully tested and documented
- Frontend: Fully tested and documented
- E2E: Validated with real scenarios
- Documentation: Complete and comprehensive

Ready for deployment or further refinement as needed.
</output>
