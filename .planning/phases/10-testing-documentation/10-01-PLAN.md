---
phase: 10-testing-documentation
plan: 01
type: execute
---

<objective>
Audit current test coverage and write unit tests for under-tested services to achieve >80% coverage target.

Purpose: Ensure all services from Phases 1-9 have adequate test coverage before moving to integration tests and documentation.
Output: Pytest coverage report + new unit tests for gaps, achieving >80% coverage for all services.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-vinted-services-extraction/06-01-SUMMARY.md
@.planning/phases/07-vinted-handlers-refactoring/07-01-SUMMARY.md
@.planning/phases/07-vinted-handlers-refactoring/07-02-SUMMARY.md
@.planning/phases/08-stats-system-refactoring/08-01-SUMMARY.md
@.planning/phases/09-schema-cleanup/09-01-SUMMARY.md

**Tech stack available:**
- Python 3.12, FastAPI, SQLAlchemy, pytest, pytest-cov
- Existing test infrastructure (from Phase 7)

**Established patterns:**
- Service layer pattern (business logic in services)
- Handler delegation pattern (handlers thin, services implement)
- Repository pattern for data access

**Constraining decisions:**
- Phase 7: Tests should mock services, not handler internals
- Phase 8: Stats system is marketplace-agnostic (test all marketplaces)
- Phase 9: Use batch_job_id FK exclusively (no batch_id string)

**Testing strategy:**
- Unit tests: Test-after pragmatic (not TDD for this phase)
- Target: >80% coverage for services
- Focus: Services created in Phases 6-9 (most recent work)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit test coverage with pytest-cov</name>
  <files>N/A (read-only analysis)</files>
  <action>
Run pytest with coverage to identify under-tested modules:

```bash
cd backend
source .venv/bin/activate
pytest --cov=services --cov=models --cov=repositories --cov-report=term-missing --cov-report=html
```

Analyze output to identify services/modules with <80% coverage. Focus on:
- Services from Phase 6: VintedPublicationService, VintedUpdateService, VintedDeletionService
- Services from Phase 7: VintedSyncService, VintedLinkProductService, VintedMessageService, VintedOrdersService
- Services from Phase 8: MarketplaceJobStats service methods
- Handlers from Phases 4-7: DirectAPIJobHandler patterns

Create coverage gap list prioritized by:
1. Services with <50% coverage (critical)
2. Services with 50-80% coverage (needs improvement)
3. Services with >80% coverage (adequate)

Save coverage report to `.planning/phases/10-testing-documentation/COVERAGE-GAPS.md` for reference.
  </action>
  <verify>pytest runs successfully, coverage report generated, COVERAGE-GAPS.md created with identified gaps</verify>
  <done>Coverage audit complete, gaps identified and prioritized, baseline established</done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for under-tested services</name>
  <files>backend/tests/services/vinted/*.py, backend/tests/services/marketplace/*.py</files>
  <action>
For each service with <80% coverage (from Task 1), write unit tests following Phase 7 patterns:

**Test structure** (from Phase 7-02):
- Mock database session (db fixture)
- Mock external dependencies (WebSocket, BatchJob queries)
- Test public API only (service methods, not private helpers)
- Use pytest fixtures for common setup

**Priority services to test:**
1. **Vinted services** (Phase 6): VintedPublicationService, VintedUpdateService, VintedDeletionService
   - Test success paths (valid input → expected result)
   - Test error paths (invalid product → exception)
   - Mock WebSocket communication

2. **Vinted wrapper services** (Phase 7): VintedSyncService, VintedLinkProductService, etc.
   - Test delegation to underlying services
   - Test error handling

3. **Stats service** (Phase 8): MarketplaceJobStats methods
   - Test get_stats() with marketplace parameter
   - Test stat creation for all marketplaces (vinted, ebay, etsy)

**What to avoid:**
- Do NOT test private methods (prefixed with _)
- Do NOT test database internals (SQLAlchemy behavior)
- Do NOT test external API calls (already covered in integration tests)
- Do NOT create tests for handlers (Phase 7 already has handler tests)

Create new test files as needed, follow naming convention `test_{service_name}.py`.
Aim for each new test file to bring service above 80% coverage.
  </action>
  <verify>pytest --cov shows >80% coverage for previously under-tested services, all new tests pass</verify>
  <done>All identified services have >80% coverage, new tests committed, no failing tests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pytest --cov` shows >80% overall coverage for services
- [ ] All newly created tests pass (no failures)
- [ ] COVERAGE-GAPS.md documents before/after coverage
- [ ] No regressions (existing tests still pass)
</verification>

<success_criteria>

- Task 1 completed: Coverage audit done, gaps identified
- Task 2 completed: Unit tests written for under-tested services
- Coverage target met: >80% for all services
- All tests pass (zero failures)
- Coverage improvements documented in COVERAGE-GAPS.md
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-documentation/10-01-SUMMARY.md`:

# Phase 10-01: Test Coverage Audit & Unit Tests Summary

**Achieved >80% test coverage for all services by identifying gaps and writing targeted unit tests**

## Accomplishments

- Coverage audit completed with pytest-cov
- X services identified with <80% coverage
- Y new test files created
- Z new tests written
- Coverage improved from A% to B%

## Files Created/Modified

- `.planning/phases/10-testing-documentation/COVERAGE-GAPS.md` - Coverage analysis
- `backend/tests/services/vinted/test_*.py` - New service tests
- `backend/tests/services/marketplace/test_*.py` - New service tests

## Decisions Made

[Coverage strategy decisions, test patterns adopted]

## Issues Encountered

[Problems found during testing, mocking challenges]

## Next Step

Ready for 10-02-PLAN.md (Integration Tests)
</output>
