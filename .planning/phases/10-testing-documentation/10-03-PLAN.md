---
phase: 10-testing-documentation
plan: 03
type: execute
---

<objective>
Document the task orchestration system architecture and update API documentation to reflect the new job + task patterns.

Purpose: Ensure the refactored architecture is well-documented for future maintenance and new marketplace integrations.
Output: ARCHITECTURE.md file + updated API docs + inline code comments for complex logic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/02-base-handler-unification/02-01-SUMMARY.md
@.planning/phases/03-directapi-handler-base/03-01-SUMMARY.md
@.planning/phases/06-vinted-services-extraction/06-01-SUMMARY.md
@.planning/phases/08-stats-system-refactoring/08-01-SUMMARY.md

**Architecture established across Phases 1-9:**
- MarketplaceTask model: Granular task tracking
- BaseJobHandler: Abstract base for all handlers
- DirectAPIJobHandler: Base for eBay/Etsy (direct API)
- VintedJobHandler: Base for Vinted (WebSocket)
- Service layer: Business logic separated from orchestration
- Repository layer: Data access patterns
- Stats system: Marketplace-agnostic tracking

**Key patterns to document:**
- Handler delegation pattern (Phases 4-7)
- Task orchestration flow (Phase 1)
- Service extraction pattern (Phase 6)
- Multi-tenant schema pattern (Phase 9)
- Retry and idempotence logic (Phase 1)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ARCHITECTURE.md documenting task orchestration system</name>
  <files>backend/ARCHITECTURE.md</files>
  <action>
Create comprehensive architecture documentation covering the task orchestration system:

**Structure:**

```markdown
# StoFlow Backend Architecture

## Overview
[Brief intro to the task orchestration system]

## Architecture Layers

### 1. Models (Database Layer)
- MarketplaceJob: Single operation on a product
- MarketplaceTask: Granular step within a job
- BatchJob: Groups multiple jobs
- MarketplaceJobStats: Per-marketplace statistics

[Include ER diagram or ASCII representation]

### 2. Handlers (Orchestration Layer)
- BaseJobHandler: Abstract base for all handlers
- DirectAPIJobHandler: For direct API marketplaces (eBay, Etsy)
- VintedJobHandler: For WebSocket-based marketplace (Vinted)

**Handler Pattern:**
- Thin orchestrators (~40 lines)
- Delegate business logic to services
- Implement abstract methods: get_service(), get_service_method_name()
- Task creation via create_tasks()

### 3. Services (Business Logic Layer)
- Publication services: Create listings on marketplaces
- Update services: Modify existing listings
- Deletion services: Remove listings
- Sync services: Synchronize data bidirectionally

**Service Pattern:**
- Encapsulate complete business logic
- Handle external API/WebSocket communication
- Return structured results (success/error)

### 4. Repositories (Data Access Layer)
- VintedJobRepository: Data access for MarketplaceJob
- Clean query patterns
- Multi-tenant schema support

## Task Orchestration Flow

### Job Lifecycle
```
PENDING → RUNNING → COMPLETED/FAILED/CANCELLED/EXPIRED
```

### Task Lifecycle
```
PENDING → RUNNING → COMPLETED/FAILED
```

[Detailed sequence diagram]

### Retry Logic
- Skip COMPLETED tasks on retry
- Re-execute FAILED tasks
- Idempotence checks prevent duplicate operations
- Max retries configurable per job

## Multi-Tenant Architecture

**Schema Pattern:**
- `public`: Shared data (users, categories, brands)
- `user_{id}`: User-specific data (products, jobs, tasks)
- PostgreSQL schema_translate_map for dynamic routing

## Adding New Marketplaces

**Step-by-step guide:**
1. Create service (e.g., ShopifyPublicationService)
2. Create handler inheriting from DirectAPIJobHandler
3. Implement get_service() and get_service_method_name()
4. Add marketplace enum value
5. Create tests following existing patterns

[Code example]

## Statistics System

**MarketplaceJobStats:**
- Tracks performance per marketplace (vinted, ebay, etsy)
- Metrics: success rates, execution times, error counts
- Optional marketplace parameter for filtering

## Performance Considerations

- Task granularity: Balance visibility vs. overhead
- Batch operations for bulk jobs
- Index optimization on status, marketplace, created_at
- Connection pooling for multi-tenant access

## Testing Strategy

- Unit tests: Services (business logic)
- Integration tests: Full job + task flow
- Retry scenarios: Idempotence, partial failure
- Coverage target: >80%

## References

- Phase 1: Foundation (MarketplaceTask model)
- Phases 4-7: Handler refactoring
- Phase 8: Stats system
- Phase 9: Schema cleanup
```

**Documentation quality:**
- Clear, concise language
- Code examples for common patterns
- Architecture diagrams (ASCII or Mermaid)
- Reference to specific phases for historical context
- Guide for adding new marketplaces
  </action>
  <verify>ARCHITECTURE.md exists, covers all layers, includes examples, readable by new developers</verify>
  <done>ARCHITECTURE.md created, comprehensive documentation for task orchestration system</done>
</task>

<task type="auto">
  <name>Task 2: Update API documentation and add code comments</name>
  <files>backend/api/*/jobs.py, backend/services/**/*.py</files>
  <action>
**Part 1: Update API Documentation**

Review and update API endpoint docstrings for job-related endpoints:

Files to update:
- `backend/api/vinted/jobs.py`
- `backend/api/ebay/jobs.py` (if exists)
- `backend/api/etsy/jobs.py` (if exists)

For each endpoint, ensure docstring includes:
- Purpose and behavior
- Request parameters and types
- Response structure and types
- Example request/response
- Error cases and status codes

Example format:
```python
@router.post("/jobs")
def create_job(request: CreateJobRequest, db: Session = Depends(get_db)):
    """
    Create a new marketplace job.

    The job will be queued for execution and processed asynchronously.
    Tasks are created based on the action type (publish, update, delete).

    Args:
        request: Job creation request with product_id, action_type
        db: Database session

    Returns:
        MarketplaceJob: Created job with status=PENDING

    Raises:
        404: Product not found
        400: Invalid action type or product state
        500: Database error

    Example:
        POST /api/vinted/jobs
        {"product_id": 123, "action_type": "publish"}
        → {"id": 456, "status": "pending", "tasks": [...]}
    """
```

**Part 2: Add Inline Code Comments**

Add comments to complex service methods that need explanation:

Focus areas:
1. **Task orchestration logic** (if complex branching)
2. **Retry logic** (idempotence checks, skip completed)
3. **Multi-tenant schema switching** (search_path logic)
4. **WebSocket communication patterns** (Vinted services)
5. **Error handling** (when non-obvious)

**What to comment:**
- WHY, not WHAT (code should be self-explanatory)
- Complex business rules
- Non-obvious error handling
- Performance optimizations
- Workarounds for external API limitations

**What NOT to comment:**
- Obvious code (self-documenting)
- Repeated patterns (extract to function instead)
- Implementation details (better to refactor)

Example:
```python
# Skip idempotent check for delete operations since deleting a non-existent
# listing is safe and returns success from Vinted API (intentional)
if self.action_type == "delete":
    return self.execute_without_idempotence_check()
```

Apply comments sparingly - aim for 5-10% of code being comments, not 50%.
  </action>
  <verify>API docstrings complete, inline comments added to complex logic, code remains readable</verify>
  <done>API documentation updated, code comments added to complex service methods</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ARCHITECTURE.md exists and is comprehensive
- [ ] API endpoints have complete docstrings
- [ ] Complex service methods have explanatory comments
- [ ] Documentation is clear and understandable
- [ ] Code remains maintainable (not over-commented)
</verification>

<success_criteria>

- Task 1 completed: ARCHITECTURE.md created with comprehensive system documentation
- Task 2 completed: API docs updated, code comments added
- Documentation covers all architectural layers
- Examples provided for common patterns
- Guide for adding new marketplaces included
- Phase 10 complete: Testing & Documentation done
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-documentation/10-03-SUMMARY.md`:

# Phase 10-03: Documentation Summary

**Comprehensive architecture documentation and API docs for the task orchestration system**

## Accomplishments

- ARCHITECTURE.md created (X lines)
- Y API endpoints documented
- Z inline code comments added
- Architecture diagrams included
- Guide for adding new marketplaces
- Documentation complete and ready for use

## Files Created/Modified

- `backend/ARCHITECTURE.md` - Complete architecture documentation
- `backend/api/vinted/jobs.py` - Updated docstrings
- `backend/services/vinted/*.py` - Added inline comments
- `backend/services/marketplace/*.py` - Added inline comments

## Decisions Made

[Documentation structure, comment style, diagram format]

## Issues Encountered

[Challenges in explaining complex flows, diagram tool choices]

## Next Step

**Phase 10 COMPLETE** - Testing & Documentation done

Ready for Phase 11 (Data Cleanup & Migration) when needed
</output>
