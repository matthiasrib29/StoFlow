# Phase 4 Plan 04-01: eBay Handlers Refactoring

## Objective

Migrate 5 eBay job handlers to use the `DirectAPIJobHandler` base class created in Phase 3, reducing code duplication by 81% and establishing uniform behavior across all eBay handlers.

## Execution Context

**Phase**: 4/12 - eBay Handlers Refactoring
**Worktree**: `~/StoFlow-task-orchestration-foundation/`
**Branch**: `feature/task-orchestration-foundation`

**Prerequisites (COMPLETED)**:
- ✅ Phase 1: TaskOrchestrator implemented with retry intelligence
- ✅ Phase 2: BaseJobHandler unified with `create_tasks()` abstract method
- ✅ Phase 3: DirectAPIJobHandler base class created (146 lines, 16/16 tests PASS)

**Tech Stack Available**:
- `DirectAPIJobHandler` abstract base class with 2 abstract methods:
  - `get_service()` → returns marketplace service instance
  - `get_service_method_name()` → returns method name to call
- Common `execute()` workflow: validate → get service → call method → handle result → catch exceptions
- Test suite pattern from Phase 3 (`test_direct_api_job_handler.py`)

**Files to Modify**:
1. `backend/services/ebay/jobs/ebay_publish_job_handler.py` (81 lines → 15 lines)
2. `backend/services/ebay/jobs/ebay_update_job_handler.py` (79 lines → 15 lines)
3. `backend/services/ebay/jobs/ebay_delete_job_handler.py` (79 lines → 15 lines)
4. `backend/services/ebay/jobs/ebay_sync_job_handler.py` (80 lines → 15 lines)
5. `backend/services/ebay/jobs/ebay_orders_sync_job_handler.py` (81 lines → 15 lines)

**Existing Tests** (to verify behavior unchanged):
- `backend/tests/unit/services/ebay/test_ebay_publish_job_handler.py`
- `backend/tests/unit/services/ebay/test_ebay_update_job_handler.py`
- `backend/tests/unit/services/ebay/test_ebay_delete_job_handler.py`
- `backend/tests/unit/services/ebay/test_ebay_sync_job_handler.py`
- `backend/tests/unit/services/ebay/test_ebay_orders_sync_job_handler.py`

## Context

### Problem Statement

**Current State**: 5 eBay handlers have 95% duplicated code (400 lines total):
- Identical validation logic (check `product_id`)
- Identical logging patterns (`log_start`, `log_success`, `log_error`)
- Identical exception handling (try/except with logging)
- Only differences: service class and method name

**Code Smell**: Copy-paste programming across all handlers.

**Impact**:
- Bug fixes require 5 identical changes
- Inconsistent behavior (e.g., one handler might log differently)
- High maintenance cost
- Hard to add new features (e.g., retry logic, timeout)

**Root Cause**: No shared abstraction for direct API handlers (before Phase 3).

### Solution (Phase 3 Delivered)

**DirectAPIJobHandler base class** provides:
- Common `execute()` workflow (5 steps)
- Abstract methods for handler-specific logic
- Uniform error handling and logging
- 81% code reduction (81 lines → 15 lines per handler)

**Migration Pattern** (from Phase 3 EXAMPLES.md):
```python
# BEFORE (81 lines)
class EbayPublishJobHandler(BaseJobHandler):
    ACTION_CODE = "ebay_publish"

    async def execute(self, job: MarketplaceJob) -> dict[str, Any]:
        product_id = job.product_id
        if not product_id:
            self.log_error("product_id is required")
            return {"success": False, "error": "product_id required"}

        self.log_start(f"Publishing product {product_id} to eBay")

        try:
            service = EbayPublicationService(self.db)
            result = await service.publish_product(product_id)
            # ... 40 more lines of logging and result handling
        except Exception as e:
            # ... 20 more lines of exception handling

# AFTER (15 lines)
class EbayPublishJobHandler(DirectAPIJobHandler):
    ACTION_CODE = "ebay_publish"

    def get_service(self) -> EbayPublicationService:
        return EbayPublicationService(self.db)

    def get_service_method_name(self) -> str:
        return "publish_product"

    def create_tasks(self, job: MarketplaceJob) -> list[str]:
        return []  # DirectAPI handlers don't use tasks (yet)
```

### Expected Outcome

**Code Reduction**:
- 400 lines → 75 lines (325 lines removed)
- 81% reduction per handler

**Quality Improvements**:
- ✅ Single point of maintenance (base class)
- ✅ Uniform behavior (same logging, error handling)
- ✅ Type safety (abstract methods enforced)
- ✅ Future-proof (easy to add retry, timeout, etc.)

**No Breaking Changes**:
- External behavior identical
- All existing tests pass unchanged
- API contracts preserved

## Tasks

### Task 1: Migrate EbayPublishJobHandler

**Priority**: Highest (most used handler)

**Current Implementation**:
- File: `backend/services/ebay/jobs/ebay_publish_job_handler.py` (81 lines)
- Service: `EbayPublicationService`
- Method: `publish_product(product_id: int)`

**Migration Steps**:
1. Read current implementation to identify service and method
2. Replace inheritance:
   ```python
   # FROM
   from services.vinted.jobs.base_job_handler import BaseJobHandler
   class EbayPublishJobHandler(BaseJobHandler):

   # TO
   from services.marketplace.direct_api_job_handler import DirectAPIJobHandler
   class EbayPublishJobHandler(DirectAPIJobHandler):
   ```
3. Remove entire `execute()` method (inherited from base)
4. Implement `get_service()`:
   ```python
   def get_service(self) -> EbayPublicationService:
       return EbayPublicationService(self.db)
   ```
5. Implement `get_service_method_name()`:
   ```python
   def get_service_method_name(self) -> str:
       return "publish_product"
   ```
6. Add `create_tasks()` (required by BaseJobHandler):
   ```python
   def create_tasks(self, job: MarketplaceJob) -> list[str]:
       return []  # DirectAPI handlers don't use tasks (yet)
   ```

**Verification**:
```bash
cd backend
source .venv/bin/activate
pytest tests/unit/services/ebay/test_ebay_publish_job_handler.py -v
```

**Expected Result**: All existing tests pass (behavior unchanged)

**Success Criteria**:
- ✅ Handler reduced to ~15 lines
- ✅ All existing tests pass
- ✅ No functional changes (external behavior identical)

---

### Task 2: Migrate EbayUpdateJobHandler

**Current Implementation**:
- File: `backend/services/ebay/jobs/ebay_update_job_handler.py` (79 lines)
- Service: `EbayUpdateService`
- Method: `update_product(product_id: int)`

**Migration Steps**: (Same pattern as Task 1)
1. Read current implementation
2. Replace inheritance with `DirectAPIJobHandler`
3. Remove `execute()` method
4. Implement `get_service()` → `EbayUpdateService`
5. Implement `get_service_method_name()` → `"update_product"`
6. Add `create_tasks()` returning `[]`

**Verification**:
```bash
pytest tests/unit/services/ebay/test_ebay_update_job_handler.py -v
```

**Success Criteria**: Same as Task 1

---

### Task 3: Migrate EbayDeleteJobHandler

**Current Implementation**:
- File: `backend/services/ebay/jobs/ebay_delete_job_handler.py` (79 lines)
- Service: `EbayDeletionService`
- Method: `delete_product(product_id: int)`

**Migration Steps**: (Same pattern as Task 1-2)
1. Read current implementation
2. Replace inheritance with `DirectAPIJobHandler`
3. Remove `execute()` method
4. Implement `get_service()` → `EbayDeletionService`
5. Implement `get_service_method_name()` → `"delete_product"`
6. Add `create_tasks()` returning `[]`

**Verification**:
```bash
pytest tests/unit/services/ebay/test_ebay_delete_job_handler.py -v
```

**Success Criteria**: Same as Task 1

---

### Task 4: Migrate EbaySyncJobHandler

**Current Implementation**:
- File: `backend/services/ebay/jobs/ebay_sync_job_handler.py` (80 lines)
- Service: `EbaySyncService`
- Method: `sync_product(product_id: int)`

**Migration Steps**: (Same pattern as Tasks 1-3)
1. Read current implementation
2. Replace inheritance with `DirectAPIJobHandler`
3. Remove `execute()` method
4. Implement `get_service()` → `EbaySyncService`
5. Implement `get_service_method_name()` → `"sync_product"`
6. Add `create_tasks()` returning `[]`

**Verification**:
```bash
pytest tests/unit/services/ebay/test_ebay_sync_job_handler.py -v
```

**Success Criteria**: Same as Task 1

---

### Task 5: Migrate EbayOrdersSyncJobHandler

**Current Implementation**:
- File: `backend/services/ebay/jobs/ebay_orders_sync_job_handler.py` (81 lines)
- Service: `EbayOrdersSyncService`
- Method: `sync_orders(product_id: int)` (verify method name)

**Migration Steps**: (Same pattern as Tasks 1-4)
1. Read current implementation
2. Replace inheritance with `DirectAPIJobHandler`
3. Remove `execute()` method
4. Implement `get_service()` → `EbayOrdersSyncService`
5. Implement `get_service_method_name()` → `"sync_orders"` (or actual method name)
6. Add `create_tasks()` returning `[]`

**Verification**:
```bash
pytest tests/unit/services/ebay/test_ebay_orders_sync_job_handler.py -v
```

**Success Criteria**: Same as Task 1

---

### Task 6: Run Full Test Suite & Create Summary

**Objective**: Verify no regressions across entire eBay handler suite.

**Steps**:
1. Run all eBay handler tests:
   ```bash
   cd backend
   source .venv/bin/activate
   pytest tests/unit/services/ebay/ -v
   ```

2. Verify all tests pass (expected: 100% pass rate)

3. Calculate metrics:
   - Lines before: 400
   - Lines after: 75
   - Lines saved: 325
   - Reduction: 81%

4. Create summary document:
   - File: `.planning/phases/04-ebay-handlers-refactoring/04-01-SUMMARY.md`
   - Content:
     - Migration results (5 handlers migrated)
     - Code reduction metrics
     - Test results (all passing)
     - Benefits realized
     - Next steps (Phase 5: Etsy handlers)

5. Commit summary:
   ```bash
   git add .planning/phases/04-ebay-handlers-refactoring/04-01-SUMMARY.md
   git commit -m "docs(phase-4): summarize eBay handlers migration results"
   ```

**Success Criteria**:
- ✅ All eBay handler tests pass (100%)
- ✅ Summary document created
- ✅ Metrics documented (325 lines saved, 81% reduction)
- ✅ No breaking changes

## Verification

### Acceptance Criteria

**Per Handler**:
- [ ] Handler file reduced to ~15 lines
- [ ] Inheritance changed to `DirectAPIJobHandler`
- [ ] `execute()` method removed (inherited)
- [ ] `get_service()` implemented correctly
- [ ] `get_service_method_name()` implemented correctly
- [ ] `create_tasks()` implemented (returns `[]`)
- [ ] All existing tests pass unchanged

**Overall**:
- [ ] 5 handlers migrated successfully
- [ ] 325 lines removed (81% reduction)
- [ ] All eBay handler tests pass (pytest)
- [ ] No breaking changes (external behavior identical)
- [ ] Summary document created

### Test Commands

```bash
# Individual handler tests
cd backend
source .venv/bin/activate

pytest tests/unit/services/ebay/test_ebay_publish_job_handler.py -v
pytest tests/unit/services/ebay/test_ebay_update_job_handler.py -v
pytest tests/unit/services/ebay/test_ebay_delete_job_handler.py -v
pytest tests/unit/services/ebay/test_ebay_sync_job_handler.py -v
pytest tests/unit/services/ebay/test_ebay_orders_sync_job_handler.py -v

# Full suite
pytest tests/unit/services/ebay/ -v
```

### Manual Verification

After migration, verify each handler:
1. Check handler file is ~15 lines (not 80)
2. Check import changed to `DirectAPIJobHandler`
3. Check no `execute()` method defined
4. Check `get_service()` returns correct service class
5. Check `get_service_method_name()` returns correct method string

## Success Criteria

**Code Quality**:
- ✅ 81% code reduction (400 lines → 75 lines)
- ✅ No code duplication (all handlers use base class)
- ✅ Type hints complete (`-> ServiceClass`, `-> str`)
- ✅ Docstrings minimal (abstract methods self-document)

**Testing**:
- ✅ 100% existing tests pass (no breaking changes)
- ✅ No new tests needed (behavior unchanged)
- ✅ Test execution time unchanged

**Architecture**:
- ✅ Single point of maintenance (DirectAPIJobHandler)
- ✅ Uniform behavior across all 5 handlers
- ✅ Future-proof (easy to add retry, timeout, etc.)
- ✅ Consistent with Phase 3 pattern

**Documentation**:
- ✅ Summary document created (metrics, results)
- ✅ Migration completed without issues
- ✅ Ready for Phase 5 (Etsy handlers)

## Output

**Modified Files** (5):
1. `backend/services/ebay/jobs/ebay_publish_job_handler.py` (81 → 15 lines)
2. `backend/services/ebay/jobs/ebay_update_job_handler.py` (79 → 15 lines)
3. `backend/services/ebay/jobs/ebay_delete_job_handler.py` (79 → 15 lines)
4. `backend/services/ebay/jobs/ebay_sync_job_handler.py` (80 → 15 lines)
5. `backend/services/ebay/jobs/ebay_orders_sync_job_handler.py` (81 → 15 lines)

**Created Files** (1):
- `.planning/phases/04-ebay-handlers-refactoring/04-01-SUMMARY.md`

**Commits** (6):
1. `refactor(ebay): migrate EbayPublishJobHandler to DirectAPIJobHandler`
2. `refactor(ebay): migrate EbayUpdateJobHandler to DirectAPIJobHandler`
3. `refactor(ebay): migrate EbayDeleteJobHandler to DirectAPIJobHandler`
4. `refactor(ebay): migrate EbaySyncJobHandler to DirectAPIJobHandler`
5. `refactor(ebay): migrate EbayOrdersSyncJobHandler to DirectAPIJobHandler`
6. `docs(phase-4): summarize eBay handlers migration results`

**Total Impact**:
- Lines removed: 325
- Lines added: ~75 (5 handlers × 15 lines)
- Net reduction: 250 lines
- Code reduction: 81%

---

**Estimated Duration**: 1-2 hours

**Risks**: Low (following proven pattern from Phase 3)

**Dependencies**: None (DirectAPIJobHandler already implemented)

**Next Phase**: Phase 5 - Etsy Handlers Refactoring (same pattern, 5 handlers)

---

*Created: 2026-01-15*
*Worktree: StoFlow-task-orchestration-foundation*
*Branch: feature/task-orchestration-foundation*
*Plan: 04-01 eBay Handlers Refactoring*
