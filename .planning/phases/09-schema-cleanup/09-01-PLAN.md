---
phase: 09-schema-cleanup
plan: 01
subsystem: database
tags: [alembic, postgresql, schema-refactoring, technical-debt]

# Dependency graph
requires:
  - phase: 08-stats-system-refactoring
    provides: Marketplace-agnostic statistics tracking
provides:
  - Removal of deprecated MarketplaceJob.batch_id column
  - Clean schema with single source of truth for batch relationships
affects: [10-testing-documentation]

# Tech tracking
tech-stack:
  removed: [MarketplaceJob.batch_id (deprecated string column)]
  patterns:
    - "Single FK pattern: use batch_job_id (int) instead of batch_id (string)"

key-files:
  will-modify:
    - backend/models/user/marketplace_job.py
    - backend/services/marketplace/marketplace_job_service.py
    - backend/services/vinted/vinted_job_service.py
    - backend/api/vinted/jobs.py
  will-create:
    - backend/migrations/versions/YYYYMMDD_HHMM_remove_marketplace_job_batch_id.py

key-decisions:
  - "Keep API contract unchanged: endpoints still accept batch_id (string) as path parameter"
  - "Remove deprecated methods get_batch_jobs() and get_batch_summary() from MarketplaceJobService"
  - "Update all code to query via batch_job_id FK instead of batch_id string"

patterns-established:
  - "Schema cleanup: remove deprecated columns after migration period"
  - "API compatibility: keep public API unchanged, refactor internal implementation"

issues-created: []
---

# Phase 9-01: Schema Cleanup - Remove MarketplaceJob.batch_id

**Remove deprecated `MarketplaceJob.batch_id` string column and migrate all code to use `batch_job_id` FK (integer) exclusively**

## Context

### Current State (Duplication)

The `MarketplaceJob` model currently has **two ways** to reference a batch:

1. **`batch_job_id`** (Integer FK) - **CORRECT**: Foreign key to `BatchJob.id`
2. **`batch_id`** (String) - **DEPRECATED**: String copy of `BatchJob.batch_id`

This creates:
- Schema duplication (two columns for same relationship)
- Data synchronization risk (batch_id might not match batch.batch_id)
- Code confusion (which column to use?)

### Target State (Clean Schema)

After Phase 9:
- **Only `batch_job_id` FK exists** in `MarketplaceJob`
- All code uses `batch_job_id` for queries
- API endpoints still accept `batch_id` (string) as parameter for backward compatibility
- No deprecated methods in services

### Analysis Summary

**Files Using `MarketplaceJob.batch_id` (String):**
1. `backend/models/user/marketplace_job.py` - Column definition (lines 77-82)
2. `backend/services/marketplace/marketplace_job_service.py` - 2 deprecated methods (lines 530-582)
3. `backend/services/vinted/vinted_job_service.py` - 1 query (line 449)
4. `backend/api/vinted/jobs.py` - 2 queries + 2 response fields (lines 134, 188, 328, 347)
5. `backend/api/ebay/jobs.py` - 1 response field (line 142)
6. `backend/repositories/vinted_job_repository.py` - 1 query (line 264)

**Files Using `batch_job_id` (FK) - Already Correct:**
- `backend/services/marketplace/batch_job_service.py` (all methods)
- `backend/api/batches.py` (most queries, but also uses BatchJob.batch_id for lookup)

**Strategy:**
1. Update all `MarketplaceJob.batch_id` queries to use `batch_job_id` FK
2. Remove deprecated service methods
3. Create migration to drop `batch_id` column
4. Keep API contract unchanged (still accept `batch_id` string as path param)

---

## Objective

Remove the deprecated `MarketplaceJob.batch_id` string column and update all code to use `batch_job_id` FK exclusively, eliminating schema duplication.

---

## Execution Context

```
@backend/models/user/marketplace_job.py
@backend/models/user/batch_job.py
@backend/services/marketplace/marketplace_job_service.py
@backend/services/marketplace/batch_job_service.py
@backend/services/vinted/vinted_job_service.py
@backend/api/vinted/jobs.py
@backend/api/ebay/jobs.py
@backend/api/batches.py
@backend/repositories/vinted_job_repository.py
@.planning/STATE.md
@.planning/ROADMAP.md
```

---

## Tasks

### Task 1: Update Code to Use batch_job_id FK

**Goal**: Replace all `MarketplaceJob.batch_id` string queries with `batch_job_id` FK queries.

**Files to Modify:**

1. **`backend/services/marketplace/marketplace_job_service.py`**
   - Remove `get_batch_jobs()` method (lines 530-547) - marked DEPRECATED
   - Remove `get_batch_summary()` method (lines 549-582) - marked DEPRECATED
   - These are replaced by `BatchJobService.get_batch_by_id()` and related methods

2. **`backend/services/vinted/vinted_job_service.py`**
   - Line 449: Update query from:
     ```python
     .filter(MarketplaceJob.batch_id == batch_id)
     ```
     To:
     ```python
     # First get BatchJob by batch_id string
     batch = self.db.query(BatchJob).filter(BatchJob.batch_id == batch_id).first()
     if not batch:
         return []
     # Then filter by FK
     .filter(MarketplaceJob.batch_job_id == batch.id)
     ```

3. **`backend/api/vinted/jobs.py`**
   - Line 134: Remove `batch_id=job.batch_id` from response (keep `batch_job_id`)
   - Line 188: Update filter to use `batch_job_id`:
     ```python
     # Get BatchJob first
     batch = db.query(BatchJob).filter(BatchJob.batch_id == batch_id).first()
     if batch:
         query = query.filter(MarketplaceJob.batch_job_id == batch.id)
     ```
   - Line 328: Update to `batch_id=batch.batch_id` (already correct, just verify)
   - Line 347: Keep returning `batch.batch_id` (API contract)

4. **`backend/api/ebay/jobs.py`**
   - Line 142: Remove `batch_id=job.batch_id` from response (keep `batch_job_id`)

5. **`backend/repositories/vinted_job_repository.py`**
   - Line 264: Update query similar to vinted_job_service.py (resolve batch_id → batch.id first)

**Verification:**
```bash
cd backend
# Ensure no more references to MarketplaceJob.batch_id in code (except model definition)
grep -rn "\.batch_id\b" --include="*.py" services/ api/ repositories/ | grep -v "batch_job_id" | grep -v "BatchJob.batch_id"
```

**Expected Result**: Only `BatchJob.batch_id` references should remain (not `MarketplaceJob.batch_id`)

---

### Task 2: Remove batch_id Column from Model

**Goal**: Remove deprecated column definition from SQLAlchemy model.

**File**: `backend/models/user/marketplace_job.py`

**Change** (lines 76-82):
```python
# BEFORE:
# Batch ID string (DEPRECATED - keep for backward compatibility)
batch_id: Mapped[str | None] = mapped_column(
    String(50),
    nullable=True,
    index=True,
    comment="DEPRECATED: Use batch_job_id instead. Groups jobs from same batch API call"
)

# AFTER:
# Remove entirely (column will be dropped in migration)
```

**Verification:**
```bash
cd backend
# Verify no batch_id in MarketplaceJob model
grep "batch_id" models/user/marketplace_job.py | grep -v "batch_job_id"
# Should return no results
```

**Expected Result**: `MarketplaceJob` model has only `batch_job_id` FK, no `batch_id` string column.

---

### Task 3: Create Alembic Migration to Drop Column

**Goal**: Create database migration to drop `marketplace_jobs.batch_id` column.

**Command**:
```bash
cd backend
source .venv/bin/activate
alembic revision -m "remove deprecated marketplace_job.batch_id column"
```

**Migration File**: `backend/migrations/versions/YYYYMMDD_HHMM_remove_marketplace_job_batch_id.py`

**upgrade() Function**:
```python
def upgrade() -> None:
    """
    Remove deprecated batch_id column from marketplace_jobs.

    All code now uses batch_job_id FK instead.

    Note: schema='tenant' handled by schema_translate_map in env.py
    """
    # Drop index first (if exists)
    op.drop_index(
        'ix_marketplace_jobs_batch_id',
        table_name='marketplace_jobs'
    )

    # Drop column
    op.drop_column(
        'marketplace_jobs',
        'batch_id'
    )
```

**downgrade() Function**:
```python
def downgrade() -> None:
    """
    Re-add batch_id column (for rollback only).

    WARNING: Data will be empty after rollback.
    """
    # Re-add column
    op.add_column(
        'marketplace_jobs',
        sa.Column('batch_id', sa.String(50), nullable=True)
    )

    # Re-create index
    op.create_index(
        'ix_marketplace_jobs_batch_id',
        'marketplace_jobs',
        ['batch_id']
    )
```

**Apply Migration**:
```bash
alembic upgrade head
```

**Sync to All Tenant Schemas**:
```bash
python scripts/sync_user_schemas.py
```

**Verification**:
```bash
# Check that column is dropped
psql -U postgres -d stoflow_dev -c "
SELECT column_name
FROM information_schema.columns
WHERE table_schema = 'template_tenant'
  AND table_name = 'marketplace_jobs'
  AND column_name = 'batch_id';
"
# Should return 0 rows

# Verify batch_job_id still exists
psql -U postgres -d stoflow_dev -c "
SELECT column_name
FROM information_schema.columns
WHERE table_schema = 'template_tenant'
  AND table_name = 'marketplace_jobs'
  AND column_name = 'batch_job_id';
"
# Should return 1 row
```

**Expected Result**: `marketplace_jobs.batch_id` column removed from all schemas, `batch_job_id` FK remains.

---

## Verification

### Code Verification

**1. No More batch_id References in Code (except BatchJob model)**:
```bash
cd backend
# Should only find BatchJob.batch_id (the business ID), not MarketplaceJob.batch_id
grep -rn "\.batch_id\b" --include="*.py" services/ api/ repositories/ | grep -v "batch_job_id"
```

**Expected**: Only references to `BatchJob.batch_id` (the UUID-like identifier), no `MarketplaceJob.batch_id`.

**2. All Queries Use batch_job_id FK**:
```bash
cd backend
grep -rn "batch_job_id" --include="*.py" services/ api/ | wc -l
```

**Expected**: Multiple references (all code migrated to FK pattern).

### Database Verification

**3. Column Dropped in All Schemas**:
```bash
psql -U postgres -d stoflow_dev -c "
SELECT table_schema, column_name
FROM information_schema.columns
WHERE table_name = 'marketplace_jobs'
  AND column_name IN ('batch_id', 'batch_job_id')
ORDER BY table_schema, column_name;
"
```

**Expected**: Only `batch_job_id` appears, no `batch_id` in any schema.

### Tests Verification

**4. Run Tests**:
```bash
cd backend
pytest backend/tests/unit/services/test_marketplace_job_service.py -v
pytest backend/tests/unit/api/test_vinted_jobs_api.py -v
pytest backend/tests/integration/test_job_cancellation.py -v
```

**Expected**: All tests pass (no references to removed column).

---

## Success Criteria

- ✅ All code uses `batch_job_id` FK instead of `batch_id` string
- ✅ Deprecated methods removed from `MarketplaceJobService`
- ✅ `MarketplaceJob` model has only `batch_job_id` column (no `batch_id`)
- ✅ Migration successfully drops column from all tenant schemas
- ✅ API contract unchanged (still accepts `batch_id` string as path param)
- ✅ All tests pass
- ✅ No schema duplication

---

## Output

### Commits (Per Task)

**Task 1 Commit**:
```
refactor(09-01): migrate all code from batch_id to batch_job_id FK

- Remove deprecated methods from MarketplaceJobService
- Update all queries to use batch_job_id FK
- Keep API contract unchanged (still accept batch_id string)

Files modified:
- backend/services/marketplace/marketplace_job_service.py
- backend/services/vinted/vinted_job_service.py
- backend/api/vinted/jobs.py
- backend/api/ebay/jobs.py
- backend/repositories/vinted_job_repository.py
```

**Task 2 Commit**:
```
refactor(09-01): remove batch_id column definition from MarketplaceJob model

Files modified:
- backend/models/user/marketplace_job.py
```

**Task 3 Commit**:
```
feat(09-01): create migration to drop marketplace_jobs.batch_id column

- Drop deprecated batch_id column
- Keep batch_job_id FK as single source of truth

Files modified:
- backend/migrations/versions/YYYYMMDD_HHMM_remove_marketplace_job_batch_id.py
```

### Documentation

Update `.planning/STATE.md`:
- Mark Phase 9 as in progress
- Add decision: "Single FK pattern for batch relationships"

Update `.planning/ROADMAP.md`:
- Mark Phase 9 tasks as complete

---

## Checkpoints

None (straightforward refactoring, no decision points).

---

## Notes

- **No data loss**: `batch_job_id` FK already contains all necessary relationship data
- **API unchanged**: Frontend/plugin continue to work without changes
- **Backward compatibility**: API still accepts `batch_id` string as parameter
- **Migration safety**: Downgrade available but data will be empty (acceptable for dev/test)

---

*Created: 2026-01-15*
*Duration estimate: ~30 min (3 tasks)*
*Complexity: Low (schema cleanup, no new features)*
