# Plan 05-01: Etsy Handlers Refactoring

## Objective

Refactor all 5 Etsy job handlers to use the DirectAPIJobHandler base class, following the same pattern successfully applied in Phase 4 for eBay handlers.

**Expected Outcome**: Reduce code duplication from ~400 lines to ~190 lines (52% reduction), improve maintainability, and ensure consistent behavior across all Etsy handlers.

---

## Execution Context

**Working Directory**: `/home/maribeiro/StoFlow-task-orchestration-foundation/`

**Key Files**:
- Base class: `backend/services/marketplace/direct_api_job_handler.py`
- Handlers to migrate: `backend/services/etsy/jobs/etsy_*_job_handler.py`
- Services: `backend/services/etsy/etsy_*_service.py`
- Tests: `tests/unit/services/etsy/`

**Reference**: Phase 4 eBay refactoring (`.planning/phases/04-ebay-handlers-refactoring/04-01-SUMMARY.md`)

---

## Context

### Current State

All 5 Etsy handlers inherit from `BaseJobHandler` and contain duplicated code for:
- Validation (product_id checks)
- Logging (log_start, log_success, log_error)
- Service instantiation and method calling
- Exception handling

**Current Handler Structure** (~78 lines each):
```python
class EtsyPublishJobHandler(BaseJobHandler):
    ACTION_CODE = "publish_etsy"

    async def execute(self, job: MarketplaceJob) -> dict[str, Any]:
        # Validation
        if not product_id:
            return {"success": False, "error": "..."}

        # Logging
        self.log_start("...")

        try:
            # Service call
            service = EtsyPublicationService(self.db)
            result = await service.publish_product(product_id)

            # Result logging
            if result.get("success"):
                self.log_success("...")
            else:
                self.log_error("...")

            return result
        except Exception as e:
            self.log_error("...")
            return {"success": False, "error": str(e)}
```

### Target State

**Target Handler Structure** (~38 lines each):
```python
class EtsyPublishJobHandler(DirectAPIJobHandler):
    """Handler for publishing products to Etsy."""

    ACTION_CODE = "publish_etsy"

    def get_service(self) -> EtsyPublicationService:
        """Return Etsy publication service instance."""
        return EtsyPublicationService(self.db)

    def get_service_method_name(self) -> str:
        """Return method name to call on service."""
        return "publish_product"

    def create_tasks(self, job: MarketplaceJob) -> list[str]:
        """Return empty task list (DirectAPI handlers don't use tasks yet)."""
        return []
```

### DirectAPIJobHandler Pattern Benefits

✅ **Single point of maintenance**: All validation, logging, exception handling in base class
✅ **Type safety**: Abstract methods enforced by Python
✅ **Consistent behavior**: Same execution flow for all handlers
✅ **Reduced code**: 52% fewer lines per handler
✅ **Easier testing**: Mock base class instead of duplicating test logic

---

## Tasks

### Task 1: Migrate EtsyPublishJobHandler

**File**: `backend/services/etsy/jobs/etsy_publish_job_handler.py`

**Changes**:
1. Change base class: `BaseJobHandler` → `DirectAPIJobHandler`
2. Remove imports: `BaseJobHandler`, `Any`, `Session`, `logger`
3. Add import: `from services.marketplace.direct_api_job_handler import DirectAPIJobHandler`
4. Remove `execute()` method entirely
5. Add `get_service()` method returning `EtsyPublicationService(self.db)`
6. Add `get_service_method_name()` returning `"publish_product"`
7. Add `create_tasks()` returning `[]`
8. Keep docstring and ACTION_CODE

**Expected Reduction**: ~78 lines → ~38 lines (40 lines removed)

**Verification**:
```bash
cd backend
source .venv/bin/activate
pytest tests/unit/services/etsy/test_etsy_publish_job_handler.py -v
```

**Commit**: `refactor: migrate EtsyPublishJobHandler to DirectAPIJobHandler`

---

### Task 2: Migrate EtsyUpdateJobHandler

**File**: `backend/services/etsy/jobs/etsy_update_job_handler.py`

**Changes**: Same pattern as Task 1
- Base class: `DirectAPIJobHandler`
- Service: `EtsyUpdateService(self.db)`
- Method: `"update_product"`

**Expected Reduction**: ~78 lines → ~38 lines (40 lines removed)

**Verification**:
```bash
pytest tests/unit/services/etsy/test_etsy_update_job_handler.py -v
```

**Commit**: `refactor: migrate EtsyUpdateJobHandler to DirectAPIJobHandler`

---

### Task 3: Migrate EtsyDeleteJobHandler

**File**: `backend/services/etsy/jobs/etsy_delete_job_handler.py`

**Changes**: Same pattern as Task 1
- Base class: `DirectAPIJobHandler`
- Service: `EtsyDeleteService(self.db)`
- Method: `"delete_product"`

**Expected Reduction**: ~78 lines → ~38 lines (40 lines removed)

**Verification**:
```bash
pytest tests/unit/services/etsy/test_etsy_delete_job_handler.py -v
```

**Commit**: `refactor: migrate EtsyDeleteJobHandler to DirectAPIJobHandler`

---

### Task 4: Migrate EtsySyncJobHandler

**File**: `backend/services/etsy/jobs/etsy_sync_job_handler.py`

**Changes**: Same pattern as Task 1
- Base class: `DirectAPIJobHandler`
- Service: `EtsySyncService(self.db)`
- Method: `"sync_product"`

**Note**: If `EtsySyncService` doesn't exist yet (like in Phase 4 with eBay), create a stub service.

**Expected Reduction**: ~78 lines → ~38 lines (40 lines removed)

**Verification**:
```bash
pytest tests/unit/services/etsy/test_etsy_sync_job_handler.py -v
```

**Commit**: `refactor: migrate EtsySyncJobHandler to DirectAPIJobHandler`

---

### Task 5: Migrate EtsyOrdersSyncJobHandler

**File**: `backend/services/etsy/jobs/etsy_orders_sync_job_handler.py`

**Changes**: Same pattern as Task 1
- Base class: `DirectAPIJobHandler`
- Service: `EtsyOrderSyncService(self.db, self.shop_id)`
- Method: `"sync_orders"`

**Note**: Like eBay, this handler may have signature incompatibility. If `EtsyOrderSyncService.sync_orders()` doesn't accept `product_id`, document for future work.

**Expected Reduction**: ~78 lines → ~38 lines (40 lines removed)

**Verification**:
```bash
pytest tests/unit/services/etsy/test_etsy_orders_sync_job_handler.py -v
```

**Commit**: `refactor: migrate EtsyOrdersSyncJobHandler to DirectAPIJobHandler`

---

### Task 6: Run Full Etsy Test Suite

**Verification**: Ensure all Etsy handlers still work after refactoring.

```bash
cd backend
source .venv/bin/activate
pytest tests/unit/services/etsy/ -v --tb=short
```

**Expected**: 95%+ test pass rate (some tests may fail if services don't exist yet, like EtsySyncService)

**No Commit**: This is verification only

---

### Task 7: Create Phase Summary

**File**: `.planning/phases/05-etsy-handlers-refactoring/05-01-SUMMARY.md`

**Content**:
- Handlers migrated (5/5)
- Lines before/after metrics
- Test results
- Problems identified (missing services, signature incompatibilities)
- Comparison with Phase 4 results

**Commit**: `docs: add Phase 5 summary (Etsy handlers refactoring)`

---

## Verification

### Success Criteria

✅ All 5 Etsy handlers inherit from `DirectAPIJobHandler`
✅ Each handler is ~38 lines (down from ~78)
✅ Total code reduction: ~200 lines (50%+)
✅ All handlers implement required abstract methods
✅ 95%+ tests passing (excluding known service gaps)
✅ No changes to service layer (only handler refactoring)

### Test Commands

```bash
# Individual handler tests
pytest tests/unit/services/etsy/test_etsy_publish_job_handler.py -v
pytest tests/unit/services/etsy/test_etsy_update_job_handler.py -v
pytest tests/unit/services/etsy/test_etsy_delete_job_handler.py -v
pytest tests/unit/services/etsy/test_etsy_sync_job_handler.py -v
pytest tests/unit/services/etsy/test_etsy_orders_sync_job_handler.py -v

# Full suite
pytest tests/unit/services/etsy/ -v --tb=short
```

### Manual Verification

1. Check each handler file is ~38 lines
2. Verify all handlers inherit from DirectAPIJobHandler
3. Confirm no `execute()` method in handlers
4. Verify abstract methods implemented: `get_service()`, `get_service_method_name()`, `create_tasks()`

---

## Output

### Git Commits (7 expected)

1. `refactor: migrate EtsyPublishJobHandler to DirectAPIJobHandler`
2. `refactor: migrate EtsyUpdateJobHandler to DirectAPIJobHandler`
3. `refactor: migrate EtsyDeleteJobHandler to DirectAPIJobHandler`
4. `refactor: migrate EtsySyncJobHandler to DirectAPIJobHandler`
5. `refactor: migrate EtsyOrdersSyncJobHandler to DirectAPIJobHandler`
6. Optional: `chore: add stub EtsySyncService` (if needed)
7. `docs: add Phase 5 summary (Etsy handlers refactoring)`

### Files Modified

- `backend/services/etsy/jobs/etsy_publish_job_handler.py`
- `backend/services/etsy/jobs/etsy_update_job_handler.py`
- `backend/services/etsy/jobs/etsy_delete_job_handler.py`
- `backend/services/etsy/jobs/etsy_sync_job_handler.py`
- `backend/services/etsy/jobs/etsy_orders_sync_job_handler.py`
- `.planning/phases/05-etsy-handlers-refactoring/05-01-SUMMARY.md` (created)

### Metrics Target

| Metric | Target |
|--------|--------|
| Handlers migrated | 5/5 (100%) |
| Lines before | ~390 lines |
| Lines after | ~190 lines |
| Reduction | 50%+ |
| Tests passing | 95%+ |

---

## Known Risks

### Risk 1: EtsySyncService May Not Exist

**Likelihood**: High (same as eBay in Phase 4)
**Impact**: Medium (handler will compile but tests may fail)
**Mitigation**: Create stub service returning `{"success": False, "error": "not implemented"}`

### Risk 2: EtsyOrdersSyncService Signature Incompatibility

**Likelihood**: High (same pattern as eBay)
**Impact**: Medium (tests will fail)
**Mitigation**: Document for future phase, create wrapper service later

### Risk 3: Existing Tests Assume BaseJobHandler Behavior

**Likelihood**: Low (tests typically mock execute() method)
**Impact**: Low (minor test adjustments may be needed)
**Mitigation**: Run tests after each migration to catch issues early

---

## Notes

- This plan replicates Phase 4's successful pattern for eBay handlers
- Each task is atomic (1 handler = 1 commit)
- Service layer remains unchanged (only handler refactoring)
- Missing services will be identified and documented for future phases
- Tests may fail if services don't exist yet (expected behavior, same as Phase 4)

---

*Created: 2026-01-15*
*Worktree: StoFlow-task-orchestration-foundation*
*Branch: feature/task-orchestration-foundation*
*Phase: 05 - Etsy Handlers Refactoring*
