---
phase: 01-task-orchestration
plan: 01
type: execute
---

<objective>
Enhance MarketplaceTask model and create migration to activate granular task tracking.

Purpose: Establish database foundation for the task orchestration system with 1-commit-per-task architecture
Output: MarketplaceTask model with step_type, step_order, is_idempotent, side_effects columns + reversible Alembic migration
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./01-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md
@backend/models/user/marketplace_task.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance MarketplaceTask model</name>
  <files>backend/models/user/marketplace_task.py</files>
  <action>
Add 4 new columns to MarketplaceTask SQLAlchemy model:

1. **step_type** (String enum): Values = 'validate', 'map', 'upload_image', 'create', 'save'
   - Purpose: Identifies what functional step this task performs
   - NOT NULL, indexed for filtering

2. **step_order** (Integer): Execution sequence within job (1, 2, 3, ...)
   - Purpose: Ensures tasks execute in correct order
   - NOT NULL, indexed with job_id for sorting

3. **is_idempotent** (Boolean): Default True
   - Purpose: Marks if task can safely retry without checking side-effects
   - Tasks with side_effects should set to False

4. **side_effects** (JSONB): Stores what was created/uploaded
   - Purpose: Enable idempotence check (e.g., {"image_id": "vinted_123", "uploaded_at": "2026-01-15T10:00:00Z"})
   - Nullable, defaults to None

**Index to add:**
- Composite index on (job_id, step_order) for efficient task retrieval during execution

**Follow SQLAlchemy 2.0 patterns:** Use Mapped[type] annotations, Column() with type_annotation.

**DO NOT:** Add business logic, modify existing columns, change table name.
  </action>
  <verify>
Run: `python -c "from backend.models.user.marketplace_task import MarketplaceTask; print('OK')"`
Should print "OK" with no import errors.
  </verify>
  <done>
- [ ] 4 new columns added with correct types (step_type, step_order, is_idempotent, side_effects)
- [ ] Composite index on (job_id, step_order) defined
- [ ] Python imports succeed without errors
- [ ] Model ready for migration creation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reversible Alembic migration</name>
  <files>backend/migrations/versions/YYYYMMDD_HHMM_add_task_orchestration_columns.py</files>
  <action>
Create Alembic migration to add columns to `marketplace_tasks` table in ALL user schemas (multi-tenant architecture).

**File naming:** Use timestamp format from other migrations (e.g., `20260115_1430_add_task_orchestration_columns.py`)

**upgrade() function:**
```python
def upgrade() -> None:
    # Add columns to public.marketplace_tasks (template schema)
    op.add_column('marketplace_tasks',
        sa.Column('step_type', sa.String(50), nullable=False, server_default='validate'),
        schema='public'
    )
    op.add_column('marketplace_tasks',
        sa.Column('step_order', sa.Integer(), nullable=False, server_default='1'),
        schema='public'
    )
    op.add_column('marketplace_tasks',
        sa.Column('is_idempotent', sa.Boolean(), nullable=False, server_default='true'),
        schema='public'
    )
    op.add_column('marketplace_tasks',
        sa.Column('side_effects', postgresql.JSONB(), nullable=True),
        schema='public'
    )

    # Create composite index
    op.create_index('idx_marketplace_tasks_job_order', 'marketplace_tasks',
                    ['job_id', 'step_order'], schema='public')

    # Fan out to all user_X schemas
    user_schemas = get_user_schemas(op.get_bind())
    for schema in user_schemas:
        if table_exists(op.get_bind(), 'marketplace_tasks', schema):
            # Add columns
            op.add_column('marketplace_tasks',
                sa.Column('step_type', sa.String(50), nullable=False, server_default='validate'),
                schema=schema
            )
            # ... repeat for other columns

            # Create index
            op.create_index(f'idx_marketplace_tasks_job_order', 'marketplace_tasks',
                            ['job_id', 'step_order'], schema=schema)
```

**downgrade() function:** Drop columns and index from all schemas (reversible).

**Comment at top:** Explain this migration enables granular task tracking with 1-commit-per-task architecture.

**Use helpers:** Import `get_user_schemas`, `table_exists`, `column_exists` from `backend.migrations.env`.

**DO NOT:** Modify data, drop tables, change existing columns. Migration must be SAFE and REVERSIBLE.
  </action>
  <verify>
Run:
1. `cd backend && alembic upgrade head` - Should succeed with no errors
2. `alembic current` - Should show new revision as head
3. `alembic downgrade -1` - Should succeed (test reversibility)
4. `alembic upgrade head` - Reapply migration
  </verify>
  <done>
- [ ] Migration file created with correct timestamp naming
- [ ] upgrade() adds 4 columns + index to ALL user schemas
- [ ] downgrade() removes columns + index (reversible)
- [ ] Migration applies successfully with `alembic upgrade head`
- [ ] Migration reverses successfully with `alembic downgrade -1`
- [ ] Comment explains 1-commit-per-task architecture
  </done>
</task>

</tasks>

<verification>
- [ ] Python can import MarketplaceTask without errors
- [ ] `alembic upgrade head` completes successfully
- [ ] `alembic downgrade -1` works (migration is reversible)
- [ ] All user schemas (user_X) have updated marketplace_tasks table
- [ ] Columns exist: step_type, step_order, is_idempotent, side_effects
- [ ] Index exists: idx_marketplace_tasks_job_order on (job_id, step_order)
- [ ] No errors in PostgreSQL logs
</verification>

<success_criteria>
- All tasks completed
- Migration reversible (passes downgrade test)
- Model ready for TaskOrchestrator implementation
- No database errors
- Multi-tenant architecture respected (all user schemas updated)
</success_criteria>

<output>
Create `.planning/phases/01-task-orchestration/01-01-SUMMARY.md` with:
- Accomplishments (model enhanced, migration created)
- Database schema changes (4 new columns, 1 index)
- Migration revision ID
- Any issues encountered
- Next steps (ready for Plan 01-02: TaskOrchestrator TDD)
</output>
