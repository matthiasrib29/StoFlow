---
phase: 03-user-settings
plan: 01
type: execute
---

<objective>
Ajouter les préférences utilisateur pour le format de titre et le style de description par défaut.

Purpose: Permettre aux utilisateurs de définir leurs préférences par défaut pour la génération de texte.
Output: 2 colonnes dans User model + endpoint API pour gérer les settings.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-backend-api/02-01-SUMMARY.md

**Service from Phase 1:**
@backend/services/product_text_generator.py

**API from Phase 2:**
@backend/api/text_generator.py
@backend/schemas/text_generator.py

**User model to modify:**
@backend/models/public/user.py

**Migration pattern reference:**
@backend/migrations/versions/20260113_1100_add_lining_column_to_products.py

**API pattern reference:**
@backend/api/auth.py (user endpoints pattern)

**Constraining decisions from previous phases:**
- TitleFormat: 1=Ultra Complete, 2=Technical, 3=Style & Trend
- DescriptionStyle: 1=Professional, 2=Storytelling, 3=Minimalist
- Values are integers 1-3, nullable (None = no preference)

**Tech stack available:**
- FastAPI with Pydantic v2
- SQLAlchemy with Alembic migrations
- User model in public schema
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add text generator preferences to User model</name>
  <files>backend/models/public/user.py, backend/migrations/versions/20260113_XXXX_add_text_generator_preferences.py</files>
  <action>
1. **Update User model** in `backend/models/public/user.py`:

Add 2 new columns after the `language` column:

```python
# Text Generator Preferences (Added: 2026-01-13)
default_title_format: Mapped[int | None] = mapped_column(
    Integer,
    nullable=True,
    comment="Default title format: 1=Ultra Complete, 2=Technical, 3=Style & Trend"
)
default_description_style: Mapped[int | None] = mapped_column(
    Integer,
    nullable=True,
    comment="Default description style: 1=Professional, 2=Storytelling, 3=Minimalist"
)
```

2. **Create Alembic migration**:

```bash
cd backend
alembic revision -m "add_text_generator_preferences_to_users"
```

Migration content:
- Add `default_title_format` column (Integer, nullable) to `public.users`
- Add `default_description_style` column (Integer, nullable) to `public.users`
- Add CHECK constraints for valid values (1-3 or NULL)

Use simple migration pattern (public schema only, no multi-tenant iteration needed).
  </action>
  <verify>
cd backend && alembic upgrade head && python -c "
from models.public.user import User
print('User columns:', [c.name for c in User.__table__.columns if 'default_' in c.name])
print('Model OK')
"
  </verify>
  <done>Migration applied. User model has default_title_format and default_description_style columns.</done>
</task>

<task type="auto">
  <name>Task 2: Create settings API endpoint</name>
  <files>backend/schemas/user_settings.py, backend/api/user_settings.py, backend/main.py</files>
  <action>
1. **Create schemas** `backend/schemas/user_settings.py`:

```python
class TextGeneratorSettings(BaseModel):
    """User preferences for text generation."""
    default_title_format: Optional[int] = Field(None, ge=1, le=3, description="Default title format (1-3)")
    default_description_style: Optional[int] = Field(None, ge=1, le=3, description="Default description style (1-3)")

    model_config = ConfigDict(from_attributes=True)

class TextGeneratorSettingsUpdate(BaseModel):
    """Update schema - same fields."""
    default_title_format: Optional[int] = Field(None, ge=1, le=3)
    default_description_style: Optional[int] = Field(None, ge=1, le=3)
```

2. **Create router** `backend/api/user_settings.py`:

```python
router = APIRouter(prefix="/users/me/settings", tags=["User Settings"])

@router.get("/text-generator", response_model=TextGeneratorSettings)
async def get_text_generator_settings(current_user: User = Depends(get_current_user)):
    """Get user's text generator preferences."""
    return TextGeneratorSettings(
        default_title_format=current_user.default_title_format,
        default_description_style=current_user.default_description_style
    )

@router.patch("/text-generator", response_model=TextGeneratorSettings)
async def update_text_generator_settings(
    settings: TextGeneratorSettingsUpdate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """Update user's text generator preferences."""
    # Update only provided fields
    if settings.default_title_format is not None:
        current_user.default_title_format = settings.default_title_format
    if settings.default_description_style is not None:
        current_user.default_description_style = settings.default_description_style

    db.commit()
    db.refresh(current_user)

    return TextGeneratorSettings(
        default_title_format=current_user.default_title_format,
        default_description_style=current_user.default_description_style
    )
```

3. **Register router** in `backend/main.py`:
- Import: `from api.user_settings import router as user_settings_router`
- Add: `app.include_router(user_settings_router, prefix="/api")`

**Logging:** Log settings updates with user_id.
  </action>
  <verify>
cd backend && python -c "
from fastapi.testclient import TestClient
from main import app

routes = [r.path for r in app.routes]
settings_routes = [r for r in routes if 'settings' in r and 'text-generator' in r]
print('Settings routes:', settings_routes)

from api.user_settings import router
print('Router prefix:', router.prefix)
print('All endpoints OK')
"
  </verify>
  <done>Endpoints GET/PATCH /users/me/settings/text-generator created and registered.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `alembic upgrade head` succeeds
- [ ] User model has `default_title_format` and `default_description_style` columns
- [ ] `from schemas.user_settings import TextGeneratorSettings` succeeds
- [ ] `from api.user_settings import router` succeeds
- [ ] Routes /users/me/settings/text-generator exist (GET and PATCH)
</verification>

<success_criteria>
- Migration created and applied
- User model updated with 2 new columns
- Schema file created at `backend/schemas/user_settings.py`
- Router file created at `backend/api/user_settings.py`
- Router registered in `backend/main.py`
- GET /users/me/settings/text-generator returns current preferences
- PATCH /users/me/settings/text-generator updates preferences
- Phase 3 complete - User settings ready
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-settings/03-01-SUMMARY.md` with:
- Columns added to User model
- Endpoints created
- Ready for Phase 4 (Frontend Composable)
</output>
