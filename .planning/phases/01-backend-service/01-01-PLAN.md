---
phase: 01-backend-service
plan: 01
type: execute
---

<objective>
Créer le service `ProductTextGeneratorService` avec la structure de base et implémenter les 3 formats de titre SEO.

Purpose: Fournir une génération déterministe et rapide de titres optimisés SEO pour les produits vestimentaires.
Output: Service Python fonctionnel avec `generate_title(product, format)` retournant des titres propres sans attributs manquants.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Existing patterns:**
@backend/services/pricing/pricing_generation_service.py (service pattern example)
@backend/models/user/product.py (Product model with all attributes)

**Product attributes reference:**
@~/StoFlow/.planning/PRODUCT_ATTRIBUTES_DUMP.md

**Title Formats (from PROJECT.md):**
- Format 1 (Ultra Complet): `{brand} {category} {gender} {size} {color} {material} {fit} {condition} {decade}`
- Format 2 (Détails Techniques): `{brand} {category} {size} {color} {material} {fit} {rise} {closure} {unique_feature} {condition}`
- Format 3 (Style & Tendance): `{brand} {category} {gender} {size} {color} {pattern} {material} {fit} {trend} {season} {origin} {condition}`

**Constraints:**
- Max 80 caractères pour titre (Vinted/eBay limit)
- Pas de doubles espaces ou virgules orphelines
- Skip silencieux des attributs manquants
- Response time < 100ms (pas d'I/O externe)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProductTextGeneratorService base structure</name>
  <files>backend/services/product_text_generator.py</files>
  <action>
Create the service file with:

1. **Imports**: typing, Product model, logger
2. **CONDITION_MAP**: Dictionary mapping condition score (0-10) to French text
   ```python
   CONDITION_MAP = {
       10: "Neuf",
       9: "Comme neuf",
       8: "Excellent état",
       7: "Très bon état",
       6: "Bon état",
       5: "État correct",
       4: "État acceptable",
       3: "État passable",
       2: "Mauvais état",
       1: "Pour pièces",
       0: "Défauts majeurs"
   }
   ```

3. **TitleFormat enum**: Enum with values ULTRA_COMPLETE=1, TECHNICAL=2, STYLE_TREND=3

4. **Class ProductTextGeneratorService** with:
   - Static methods (no DB dependency, pure functions)
   - `_get_condition_text(condition: int) -> str`: Map score to text
   - `_clean_title(title: str) -> str`: Remove double spaces, trim, handle max length (80 chars)
   - `_safe_get(product, attr: str, default: str = "") -> str`: Safely get attribute value

**Do NOT use LLM or external APIs.** This is pure Python string formatting.

Follow existing service patterns (docstrings Google style, type hints on public methods).
  </action>
  <verify>python -c "from services.product_text_generator import ProductTextGeneratorService, TitleFormat, CONDITION_MAP; print('Import OK')"</verify>
  <done>Service file exists with CONDITION_MAP, TitleFormat enum, and helper methods. Imports successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Implement generate_title() with 3 formats</name>
  <files>backend/services/product_text_generator.py</files>
  <action>
Add the `generate_title()` method to ProductTextGeneratorService:

```python
@staticmethod
def generate_title(product: Product, format: TitleFormat = TitleFormat.ULTRA_COMPLETE) -> str:
    """
    Generate SEO-optimized title for a product.

    Args:
        product: Product model instance with attributes
        format: TitleFormat enum (1=Ultra Complete, 2=Technical, 3=Style & Trend)

    Returns:
        Clean title string (max 80 chars), missing attributes silently skipped
    """
```

**Format 1 (Ultra Complet)** - Order: brand, category, gender, size, color, material, fit, condition, decade
- Example: "Levi's Jeans Men W32/L34 Blue Denim Slim Très bon état 90s"

**Format 2 (Détails Techniques)** - Order: brand, category, size, color, material, fit, rise, closure, unique_feature, condition
- Example: "Levi's Jeans W32/L34 Blue Denim Slim Mid-rise Button fly Selvedge Excellent état"

**Format 3 (Style & Tendance)** - Order: brand, category, gender, size, color, pattern, material, fit, trend, season, origin, condition
- Example: "Levi's Jeans Men W32/L34 Blue Solid Denim Slim Vintage All seasons USA Bon état"

**Implementation details:**
1. Build list of non-empty attribute values based on format
2. For `colors`: use first color if list, join with "/" if multiple
3. For `unique_feature`: use first feature only (for title brevity)
4. For `condition`: use CONDITION_MAP[product.condition]
5. Join with space, clean with `_clean_title()`
6. Truncate to 80 chars if needed (prefer cutting at word boundary)

**Handle missing attributes gracefully**: If `product.brand` is None or empty, skip it entirely (no placeholder text).
  </action>
  <verify>
cd backend && python -c "
from models.user.product import Product
from services.product_text_generator import ProductTextGeneratorService, TitleFormat

# Create mock product
class MockProduct:
    brand = 'Levi\\'s'
    category = 'jeans'
    gender = 'Men'
    size_normalized = 'W32/L34'
    colors = ['Blue']
    material = 'Denim'
    fit = 'Slim'
    condition = 7
    decade = '90s'
    rise = None
    closure = None
    unique_feature = None
    pattern = None
    trend = None
    season = None
    origin = None

p = MockProduct()
title1 = ProductTextGeneratorService.generate_title(p, TitleFormat.ULTRA_COMPLETE)
print(f'Format 1: {title1}')
print(f'Length: {len(title1)} chars')
assert len(title1) <= 80, 'Title too long'
assert 'Levi' in title1, 'Brand missing'
print('OK')
"
  </verify>
  <done>generate_title() works for all 3 formats. Handles missing attributes. Respects 80 char limit. Tests pass.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from services.product_text_generator import ProductTextGeneratorService"` succeeds
- [ ] CONDITION_MAP has all 11 values (0-10)
- [ ] TitleFormat enum has 3 values
- [ ] generate_title() returns string ≤80 chars
- [ ] Missing attributes are silently skipped (no "None" in output)
- [ ] No double spaces in output
</verification>

<success_criteria>
- Service file created at `backend/services/product_text_generator.py`
- CONDITION_MAP maps 0-10 to French condition text
- TitleFormat enum with 3 formats
- generate_title(product, format) works for all 3 formats
- Output is clean (no double spaces, ≤80 chars)
- Missing attributes handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-service/01-01-SUMMARY.md`
</output>
